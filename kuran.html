<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dijital Kuran</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <link
        href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Scheherazade+New:wght@400;700&display=swap"
        rel="stylesheet">

    <style>
        /* --- YEREL FONTLAR (fonts klasöründen) --- */
        /* Klasöründeki dosya isimlerinin AYNISI olduğundan emin ol */

        @font-face {
            font-family: 'Hafs';
            src: url('fonts/UthmanicHafs_V22.ttf') format('truetype');
        }

        @font-face {
            font-family: 'Warsh';
            src: url('fonts/UthmanicWarsh_V21.ttf') format('truetype');
        }

        @font-face {
            font-family: 'Kufi';
            src: url('fonts/KFGQPC-KufiStyV14.ttf') format('truetype');
        }

        /* Ana Metin Ayarları */
        .arabic-text {
            /* Varsayılan font (Javascript ile değişecek) */
            /* Varsayılan font (Javascript ile değişecek ama CSS fallback) */
            font-family: 'Scheherazade New', 'Hafs', serif;
            text-align: justify;
            text-align-last: center;
            direction: rtl;
            text-justify: inter-word;
        }

        .sajdah-ayah {
            color: #dc2626;
        }

        .ayah-symbol {
            font-family: sans-serif;
            font-size: 0.8em;
            color: #d97706;
            margin: 0 5px;
            display: inline-block;
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Safe Area Fix */
        body {
            padding-bottom: env(safe-area-inset-bottom);
        }
    </style>
</head>

<body class="bg-stone-100 h-screen flex flex-col overflow-hidden select-none">

    <div class="bg-white border-b border-stone-200 p-2 shadow-sm z-20 flex justify-between items-center h-14 shrink-0">

        <div class="flex items-center gap-1">
            <button onclick="toggleAyarlar()" class="p-2 text-stone-600 hover:bg-stone-100 rounded">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
            </button>

            <a href="index.html"
                class="flex items-center gap-1 bg-emerald-700 text-white hover:bg-emerald-800 px-3 py-1.5 rounded shadow-md text-sm font-bold no-underline transition-colors border-b-2 border-emerald-900">
                <span class="text-lg">&larr;</span>
                <span class="hidden md:block">Ana Menü</span>
            </a>
        </div>

        <!-- Bookmark & Favorite Icons -->
        <button onclick="toggleBookmark()" class="p-2 text-stone-400 hover:text-emerald-600 transition-colors"
            title="Kaldığım Yer">
            <svg id="iconBookmark" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z" />
            </svg>
        </button>
        <button onclick="toggleFavorite()" class="p-2 text-stone-400 hover:text-yellow-500 transition-colors"
            title="Favorilere Ekle">
            <svg id="iconStar" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
            </svg>
        </button>

        <!-- Page Inputs -->
        <div class="flex gap-2 items-center">
            <select id="surahSelect"
                class="border border-stone-300 p-1 rounded w-24 md:w-36 text-sm bg-stone-50 font-semibold"
                onchange="sureDegistir()">
                <option>Yükleniyor...</option>
            </select>
            <div class="flex items-center border border-stone-300 rounded bg-white overflow-hidden h-8">
                <input type="number" id="pageInput" min="0" max="604" value="1"
                    class="w-10 text-center outline-none text-sm font-bold" onchange="sayfayaGitInput()">
            </div>
        </div>
    </div>
    </div>

    <div id="settingsPanel" class="hidden absolute top-14 left-0 w-full bg-white border-b p-4 shadow-lg z-30">
        <div class="flex flex-col gap-4 max-w-sm mx-auto">

            <div>
                <label class="text-xs font-bold text-gray-500 mb-1 block">Yazı Tipi</label>
                <select id="fontSelect" class="w-full border p-2 rounded bg-stone-50"
                    onchange="ayarGuncelle('fontFamily', this.value)">
                    <option value="Hafs">Klassik (Hafs)</option>
                    <option value="Scheherazade New" selected>Scheherazade (Kıvrımlı)</option>
                    <option value="Amiri">Amiri (Okunaklı)</option>
                    <option value="Kufi">Kufi (Köşeli/Modern)</option>
                    <option value="Warsh">Warsh (Mağribi)</option>
                </select>
            </div>

            <div>
                <label class="text-xs font-bold text-gray-500">Yazı Boyutu</label>
                <input type="range" min="18" max="60" value="28" class="w-full accent-emerald-600"
                    oninput="ayarGuncelle('fontSize', this.value)">
            </div>
            <div>
                <label class="text-xs font-bold text-gray-500">Satır Aralığı</label>
                <input type="range" min="1.5" max="4.5" step="0.1" value="2.5" class="w-full accent-emerald-600"
                    oninput="ayarGuncelle('lineHeight', this.value)">
            </div>
        </div>
    </div>

    <!-- TOUCH CONTAINER (Swipe Area) -->
    <div class="flex-1 overflow-y-auto no-scrollbar bg-stone-100 relative" id="scrollContainer">
        <!-- Overlay for Swipe Hint (Optional) -->
        <div id="swipeHint" class="absolute inset-0 pointer-events-none z-10 hidden flex items-center justify-center">
            <div class="bg-black bg-opacity-50 text-white px-4 py-2 rounded-full text-sm">Kaydırılarak Değiştiriliyor
            </div>
        </div>

        <div class="max-w-2xl mx-auto bg-white min-h-full shadow-lg border-x border-stone-200 flex flex-col pb-20 transition-transform duration-300"
            id="mainCard">

            <div id="pageContent" class="flex-1 px-4 py-6 md:px-10 md:py-10 arabic-text text-stone-900">
                Yükleniyor...
            </div>

            <div class="text-center py-2 text-stone-400 text-xs border-t border-stone-50 mt-auto">
                - <span id="lblPage">1</span> -
            </div>
        </div>
    </div>

    <!-- GİZLİ BUTONLAR (Fallback Navigation - Yarı Saydam) -->
    <!-- Kullanıcı "Swipe" istedi ama bazı durumlar için opsiyonel oklar kalabilir veya tamamen kaldırılabilir. 
         Burada tamamen kaldırıp yerine "Sayfa Bilgisi" çubuğu koyuyoruz -->
    <div
        class="bg-white border-t border-stone-200 h-8 shrink-0 z-20 flex justify-center items-center text-xs text-stone-400">
        <span class="mr-2">&larr; Sonraki</span> | <span class="ml-2">Önceki &rarr;</span>
    </div>

    <script src="data.js"></script>
    <script src="maps.js"></script>

    <script>
        let aktifSayfa = 1;
        const secdeAyetleri = { 7: [206], 13: [15], 16: [50], 17: [109], 19: [58], 22: [18, 77], 25: [60], 27: [26], 32: [15], 38: [24], 41: [38], 53: [62], 84: [21], 96: [19] };

        // Ayarları Hafızadan Yükle
        let userSettings = {
            fontSize: localStorage.getItem('quran_fs') || 28,
            lineHeight: localStorage.getItem('quran_lh') || 2.5,
            fontFamily: localStorage.getItem('quran_font') || 'Scheherazade New'
        };

        // Bookmark & Favorites
        let bookmarkPage = parseInt(localStorage.getItem('quran_bookmark_page')) || 0;
        let favorites = JSON.parse(localStorage.getItem('quran_favorites') || "[]");

        window.onload = function () {
            // Veri Dosyası Kontrolü
            if (typeof quranData === 'undefined' || typeof pageMappings === 'undefined') {
                document.getElementById('pageContent').innerHTML = "<br>HATA: data.js veya maps.js yüklenemedi.";
                return;
            }

            // 1. Ayarları Uygula
            applySettings();
            document.querySelector('input[oninput*="fontSize"]').value = userSettings.fontSize;
            document.querySelector('input[oninput*="lineHeight"]').value = userSettings.lineHeight;
            document.getElementById('fontSelect').value = userSettings.fontFamily;

            // 2. Sure Listesini Doldur
            sureListesiniDoldur();

            // 3. URL'den Sayfa Numarasını Al
            const urlParams = new URLSearchParams(window.location.search);
            const gelenSayfa = urlParams.get('sayfa');

            if (gelenSayfa) {
                aktifSayfa = parseInt(gelenSayfa);
            } else {
                aktifSayfa = parseInt(localStorage.getItem('son_kaldigim_sayfa')) || 1;
            }

            // 4. Sayfayı Çiz
            sayfayiCiz(aktifSayfa);
        };

        function applySettings() {
            const content = document.getElementById('pageContent');
            content.style.fontSize = userSettings.fontSize + 'px';
            content.style.lineHeight = userSettings.lineHeight;
            content.style.fontFamily = userSettings.fontFamily + ', serif';
        }

        function ayarGuncelle(tip, deger) {
            userSettings[tip] = deger;
            if (tip === 'fontSize') localStorage.setItem('quran_fs', deger);
            if (tip === 'lineHeight') localStorage.setItem('quran_lh', deger);
            if (tip === 'fontFamily') localStorage.setItem('quran_font', deger);
            applySettings();
        }

        function toggleAyarlar() {
            document.getElementById('settingsPanel').classList.toggle('hidden');
        }

        function sureListesiniDoldur() {
            const select = document.getElementById('surahSelect');
            select.innerHTML = '<option value="">Sure Seç...</option>';
            quranData.forEach(s => {
                let opt = document.createElement('option');
                opt.value = s.id;
                opt.text = `${s.id}. ${s.transliteration}`;
                select.appendChild(opt);
            });
        }

        function sayfayiCiz(sayfaNo) {
            const div = document.getElementById('pageContent');
            const lblPage = document.getElementById('lblPage');
            const pageInput = document.getElementById('pageInput');

            // --- 1. GÖRSEL KISIM ---
            if (sayfaNo === 0) {
                lblPage.innerText = "Fâtiha (0)";
                pageInput.value = 0;
            } else {
                lblPage.innerText = sayfaNo;
                pageInput.value = sayfaNo;
            }

            div.innerHTML = "";
            // --- 2. HARİTA EŞLEŞTİRME ---
            const map = pageMappings[sayfaNo + 1];
            if (!map) {
                div.innerHTML = "<div class='text-center mt-10'>Sayfa sonu.</div>";
                return;
            }
            let html = "";
            map.forEach(item => {
                const sure = quranData.find(s => s.id === item.surah);
                if (!sure) return;

                // Sure Başlığı
                if (item.start === 1) {
                    html += `<div class="w-full flex justify-center mt-4 mb-4">
                        <div class="border-y-2 border-stone-300 w-full text-center py-2 bg-stone-50">
                            <span class="text-xl font-bold text-stone-700 font-serif">${sure.name}</span>
                        </div>
                     </div>`;

                    if (sure.id !== 1 && sure.id !== 9) {
                        html += `<div class="w-full text-center mb-4 mt-2 text-2xl">بِسۡمِ ٱللَّهِ ٱلرَّحۡمَٰنِ ٱلرَّحِيمِ</div>`;
                    }
                }
                // Ayetler
                const ayetler = sure.verses.filter(v => v.id >= item.start && v.id <= item.end);
                ayetler.forEach(v => {
                    let isSajdah = secdeAyetleri[sure.id] && secdeAyetleri[sure.id].includes(v.id);
                    let textClass = isSajdah ? "sajdah-ayah" : "";
                    html += `<span class="${textClass}">${v.text} <span class="ayah-symbol select-none text-xl">&#64831;${v.id}&#64830;</span></span> `;
                });
            });

            div.innerHTML = html;
            document.getElementById('scrollContainer').scrollTop = 0;
            localStorage.setItem('son_kaldigim_sayfa', sayfaNo);

            // İkonları Güncelle
            updateIcons();
        }

        function sayfaDegis(yon) {
            let yeni = aktifSayfa + yon;
            if (yeni >= 0 && yeni <= 604) { aktifSayfa = yeni; sayfayiCiz(aktifSayfa); }
        }

        function sayfayaGitInput() {
            let val = parseInt(document.getElementById('pageInput').value);
            let gercekSayfa = val;

            if (gercekSayfa >= 0 && gercekSayfa <= 604) {
                aktifSayfa = gercekSayfa;
                sayfayiCiz(aktifSayfa);
            }
        }

        function sureDegistir() {
            let id = parseInt(document.getElementById('surahSelect').value);
            let hedefSayfa = 1;
            for (var p in pageMappings) {
                var m = pageMappings[p];
                for (var i = 0; i < m.length; i++) {
                    if (m[i].surah == id && m[i].start == 1) {
                        hedefSayfa = parseInt(p);
                        break;
                    }
                }
            }
            aktifSayfa = hedefSayfa - 1;
            sayfayiCiz(aktifSayfa);
        }

        /* --- SWIPE NAVIGATION IMPLEMENTATION --- */
        let touchStartX = 0;
        let touchEndX = 0;
        const mainCard = document.getElementById('mainCard');
        const minSwipeDistance = 50;

        document.getElementById('scrollContainer').addEventListener('touchstart', e => {
            touchStartX = e.changedTouches[0].screenX;
        }, { passive: true });

        document.getElementById('scrollContainer').addEventListener('touchend', e => {
            touchEndX = e.changedTouches[0].screenX;
            handleSwipe();
        }, { passive: true });

        // PC MOUSE DESTEĞİ (Test İçin)
        document.getElementById('scrollContainer').addEventListener('mousedown', e => {
            touchStartX = e.screenX;
        });

        document.getElementById('scrollContainer').addEventListener('mouseup', e => {
            touchEndX = e.screenX;
            handleSwipe();
        });

        function handleSwipe() {
            const distance = touchEndX - touchStartX;

            if (Math.abs(distance) > minSwipeDistance) {
                // Hareketi algıla
                if (distance > 0) {
                    // SAĞA KAYDIRMA (->) = SONRAKİ SAYFA (Sayfayı Sağa Çekince Sol Taraf Gelir)
                    // Kullanıcı talebi üzerine: "Kuran mantığı" -> Sağdan sola.
                    sayfaDegis(1);
                } else {
                    // SOLA KAYDIRMA (<-) = ÖNCEKİ SAYFA (Sayfayı Sola Çekince Sağ Taraf Gelir)
                    sayfaDegis(-1);
                }
            }
        }

        /* --- BOOKMARK ACTIONS --- */
        function toggleBookmark() {
            if (bookmarkPage === aktifSayfa) {
                bookmarkPage = 0;
                localStorage.removeItem('quran_bookmark_page');
                showToast("Ayraç kaldırıldı");
            } else {
                bookmarkPage = aktifSayfa;
                localStorage.setItem('quran_bookmark_page', aktifSayfa);
                showToast("Sayfa ayracı eklendi");
            }
            updateIcons();
        }

        function toggleFavorite() {
            const map = pageMappings[aktifSayfa + 1];
            if (!map || map.length === 0) return;

            const firstItem = map[0];
            const sure = quranData.find(s => s.id === firstItem.surah);
            const title = `${sure.name} Suresi (${aktifSayfa}. Sayfa)`;

            const existsIndex = favorites.findIndex(f => f.page === aktifSayfa);

            if (existsIndex > -1) {
                favorites.splice(existsIndex, 1);
                showToast("Favorilerden çıkarıldı");
            } else {
                favorites.push({ page: aktifSayfa, title: title, date: new Date().toLocaleDateString() });
                showToast("Favorilere eklendi");
            }

            localStorage.setItem('quran_favorites', JSON.stringify(favorites));
            updateIcons();
        }

        function updateIcons() {
            const bookIcon = document.getElementById('iconBookmark');
            const starIcon = document.getElementById('iconStar');

            if (bookmarkPage === aktifSayfa) {
                bookIcon.classList.add('text-emerald-600', 'fill-current');
                bookIcon.classList.remove('text-stone-400');
            } else {
                bookIcon.classList.remove('text-emerald-600', 'fill-current');
                bookIcon.classList.add('text-stone-400');
            }

            const isFav = favorites.some(f => f.page === aktifSayfa);
            if (isFav) {
                starIcon.classList.add('text-yellow-500', 'fill-current');
                starIcon.classList.remove('text-stone-400');
            } else {
                starIcon.classList.remove('text-yellow-500', 'fill-current');
                starIcon.classList.add('text-stone-400');
            }
        }

        function showFavorites() {
            const listConf = document.getElementById('favoritesList');
            const modal = document.getElementById('favoritesModal');

            if (favorites.length === 0) {
                listConf.innerHTML = '<p class="text-center text-stone-400 mt-4">Henüz favori eklenmedi.</p>';
            } else {
                let html = '<div class="flex flex-col gap-2">';
                favorites.forEach((fav, idx) => {
                    html += `
                    <div onclick="document.getElementById('favoritesModal').classList.add('hidden'); sayfayiCiz(${fav.page});" 
                         class="p-3 border rounded hover:bg-emerald-50 cursor-pointer flex justify-between items-center group">
                        <div>
                            <div class="font-bold text-stone-700">${fav.title}</div>
                            <div class="text-xs text-stone-400">${fav.date}</div>
                        </div>
                        <button onclick="event.stopPropagation(); removeFav(${idx})" class="text-stone-300 hover:text-red-500 p-2">
                           <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </div>`;
                });
                html += '</div>';
                listConf.innerHTML = html;
            }
            modal.classList.remove('hidden');
            toggleAyarlar();
        }

        function removeFav(index) {
            favorites.splice(index, 1);
            localStorage.setItem('quran_favorites', JSON.stringify(favorites));
            showFavorites();
            updateIcons();
        }

        function showToast(msg) {
            const div = document.createElement('div');
            div.className = "fixed bottom-10 left-1/2 transform -translate-x-1/2 bg-stone-800 text-white px-4 py-2 rounded-full text-sm shadow opacity-90 transition-opacity duration-500 z-50";
            div.innerText = msg;
            document.body.appendChild(div);
            setTimeout(() => {
                div.style.opacity = '0';
                setTimeout(() => div.remove(), 500);
            }, 2000);
        }
    </script>

</body>

</html>
