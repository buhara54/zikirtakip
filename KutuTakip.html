<!DOCTYPE html>
<html lang="tr">

<head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        body {
            background: #f8f9fa;
            padding-bottom: 60px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        /* Header Tasarımı */
        .kutu-header {
            background: linear-gradient(93deg, #0BB351, #264d3a);
            color: white;
            padding: 1rem;
            margin-bottom: 1.5rem;
            border-radius: 0 0 20px 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        /* Dashboard Kartları */
        .dash-card {
            border: none;
            border-radius: 15px;
            background: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s;
            height: 100%;
            padding: 1rem 0.5rem;
        }

        .dash-card:active {
            transform: scale(0.98);
        }

        .dash-val {
            font-size: 1.5rem;
            font-weight: bold;
            margin: 5px 0;
        }

        .dash-label {
            font-size: 0.8rem;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Ana Menü Butonları */
        .menu-btn {
            border: none;
            border-radius: 15px;
            padding: 1.5rem;
            color: white;
            font-weight: 600;
            width: 100%;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .menu-btn:active {
            transform: scale(0.97);
        }

        .btn-ziyaret {
            background: linear-gradient(135deg, #0d6efd, #0a58ca);
        }

        .btn-stok {
            background: linear-gradient(135deg, #d1fa1c, #d1fa1c);
        }

        .btn-rapor {
            background: linear-gradient(135deg, #198754, #146c43);
        }

        .btn-duzenle {
            background: linear-gradient(135deg, #a16f28, #a16f28);
        }

        /* Liste Elemanları */
        .list-group-item.bg-success-subtle {
            border-left: 5px solid #198754;
        }

        /* Progress Bar Stilleri */
        .progress-container {
            background: white;
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
            text-align: center;
        }

        .custom-progress {
            height: 25px;
            background-color: #e9ecef;
            border-radius: 15px;
            overflow: hidden;
            margin-top: 5px;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .custom-bar {
            height: 100%;
            color: white;
            font-weight: bold;
            font-size: 0.9rem;
            line-height: 25px;
            transition: width 0.6s ease;
            width: 0%;
        }

        .bg-low {
            background: linear-gradient(45deg, #d32f2f, #ef5350);
        }

        /* Kırmızı */
        .bg-mid {
            background: linear-gradient(45deg, #f57c00, #ff9800);
        }

        /* Turuncu */
        .bg-high {
            background: linear-gradient(45deg, #2e7d32, #43a047);
        }

        /* Yeşil */

        /* DÜZENLEME BUTONU (Özel Renk: Taba #a16f28) */
        .btn-duzenle {
            background-color: #a16f28 !important;
            color: white !important;
            border-color: #8c5e20 !important;
        }

        /* Tam Liste Butonu (Base) */
        .btn-full-list {
            border: none;
            border-radius: 15px;
            padding: 1rem;
            width: 100%;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        /* Aktif Liste İçin Özel Mavi Gradient */
        .btn-full-list-active {
            background: linear-gradient(135deg, #17a2b8, #138496);
            color: rgb(144, 214, 238);
        }

        .btn-full-list:active {
            transform: scale(0.98);
        }

        /* YAZDIRMA AYARLARI (GÜNCELLENDİ: Scroll Çözümü + Kağıt Tasarrufu) */
        @media print {

            /* 1. Temel Gizleme */
            body * {
                visibility: hidden;
            }

            /* 2. Sayfa Yapısını Sıfırla */
            body,
            html {
                height: auto !important;
                overflow: visible !important;
                font-size: 10pt !important;
                /* Genel yazı boyutunu küçült */
                background: white !important;
            }

            /* --- SENARYO A: LİSTE MODALI AÇIKSA --- */
            .modal.show {
                visibility: visible !important;
                position: absolute !important;
                left: 0 !important;
                top: 0 !important;
                width: 100% !important;
                height: auto !important;
                overflow: visible !important;
                background: white !important;
                margin: 0 !important;
                padding: 0 !important;
            }

            .modal.show * {
                visibility: visible !important;
            }

            /* --- KAĞIT TASARRUFU & YILLIK RAPOR CSS (Print Mode) --- */

            /* Yıllık Rapor Başlıklarını Küçült (Ay isimleri yerine sayı) */
            .annual-header .month-name {
                display: none !important;
            }

            .annual-header .month-num {
                display: inline-block !important;
            }

            .modal-dialog {
                position: static !important;
                margin: 0 !important;
                padding: 0 !important;
                width: 100% !important;
                max-width: 100% !important;
                height: auto !important;
                transform: none !important;
            }

            .modal-content {
                border: none !important;
                box-shadow: none !important;
                height: auto !important;
                overflow: visible !important;
                padding: 0 !important;
            }

            .modal-body,
            #tum-liste-container {
                height: auto !important;
                overflow: visible !important;
                padding: 0 !important;
                margin: 0 !important;
            }

            /* --- KAĞIT TASARRUFU AYARLARI (YENİ EKLENDİ) --- */

            /* Kartlar arası boşluğu azalt */
            .card {
                margin-bottom: 10px !important;
                border: 1px solid #000 !important;
                /* Silik değil net çizgi */
                box-shadow: none !important;
                break-inside: avoid;
                /* Sayfa ortasında bölünmeyi engelle */
            }

            /* Kart başlıklarını sıkılaştır */
            .card-header {
                padding: 4px 8px !important;
                font-size: 11pt !important;
                background-color: #eee !important;
                /* Yazıcıda gri ton */
                color: #000 !important;
            }

            /* Tablo hücrelerini sıkılaştır */
            .table td,
            .table th {
                padding: 2px 4px !important;
                /* Çok dar boşluk */
                font-size: 9pt !important;
                /* Dükkan detayları küçük olsun */
                border: 1px solid #999 !important;
                /* Hücre çizgileri belirgin olsun */
                white-space: normal !important;
                /* Uzun metinler alt satıra geçsin */
            }

            /* Ana Başlık */
            #tum-liste-baslik h5 {
                font-size: 14pt !important;
                margin-bottom: 10px !important;
                text-align: center;
            }

            /* Linkleri ve gereksizleri temizle */
            a {
                text-decoration: none !important;
                color: #000 !important;
            }

            a[href]:after {
                content: none !important;
            }

            /* --- SENARYO B: LİSTE KAPALIYSA (RAPOR YAZDIR) --- */
            body:not(:has(.modal.show)) #ekran-rapor,
            body:not(:has(.modal.show)) #ekran-rapor * {
                visibility: visible;
            }

            body:not(:has(.modal.show)) #ekran-rapor {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                padding: 0;
                margin: 0;
            }

            /* --- ORTAK GİZLEMELER --- */
            .no-print,
            .btn-close,
            .modal-header .btn {
                display: none !important;
            }

            .kutu-header {
                display: none;
            }
        }

        /* --- TÜM LİSTE TABLO HİZALAMA AYARLARI --- */
        /* Tabloyu sabit düzene zorla */
        #tum-liste-container table {
            table-layout: fixed !important;
            width: 100% !important;
        }

        /* 1. Sütun: Dükkan Adı (%25) */
        #tum-liste-container table th:nth-child(1),
        #tum-liste-container table td:nth-child(1) {
            width: 25% !important;
            overflow: hidden;
            /* Taşarsa gizle veya alt satıra geçsin */
        }

        /* 2. Sütun: Sahibi (%20) */
        #tum-liste-container table th:nth-child(2),
        #tum-liste-container table td:nth-child(2) {
            width: 20% !important;
        }

        /* 3. Sütun: Telefon (%15) */
        #tum-liste-container table th:nth-child(3),
        #tum-liste-container table td:nth-child(3) {
            width: 15% !important;
        }

        /* 4. Sütun: Adres ve Detay (%40 - En Geniş) */
        #tum-liste-container table th:nth-child(4),
        #tum-liste-container table td:nth-child(4) {
            width: 40% !important;
        }

        /* --- Z-INDEX DÜZELTMESİ (Alert En Üstte) --- */
        #ozelAlertModal {
            z-index: 1060 !important;
            /* Standart Bootstrap Modal: 1055 */
        }

        /* Eğer arka plan karartısı da üstte kalsın istenirse (Opsiyonel): */
        .modal-backdrop {
            z-index: 1040;
        }

        /* Alert açıldığında gelen backdrop (karartı) en üstte olsun */
        .modal-backdrop.show:nth-of-type(2) {
            z-index: 1058 !important;
        }

        /* Header İkon Butonları */
        .header-icon-btn {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            object-fit: cover;
            transition: transform 0.2s;
            background: white;
            /* Resim şeffafsa arkası beyaz olsun */
        }

        .header-icon-btn:hover {
            transform: scale(1.1);
            border-color: #fff;
        }

        /* İkonlar arası boşluk */
        .header-icons-wrapper {
            display: flex;
            gap: 10px;
            /* İki ikon arasındaki boşluk */
        }
    </style>
</head>

<body>

    <div class="modal fade no-print" id="ozelAlertModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-header text-white" id="ozelAlertHeader">
                    <h5 class="modal-title">Bilgi</h5>
                </div>
                <div class="modal-body p-4" id="ozelAlertBody">Mesaj</div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-secondary" style="display:none;"
                        id="btnAlertCancel">İptal</button>
                    <button type="button" class="btn btn-primary px-4" id="btnAlertOk">Tamam</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade no-print" id="listeModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content border-0 shadow">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title"><i class="fa fa-list"></i> Dükkan Listesi</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    <div id="liste-modal-icerik" class="list-group list-group-flush"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade no-print" id="bolumYonetimModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-header bg-secondary text-white">
                    <h5 class="modal-title"><i class="fa fa-cogs"></i> Bölüm Yönetimi</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- 1. BÖLÜM LİSTESİ VE İŞLEMLER -->
                    <div id="bolum-yonetim-main">
                        <label class="form-label fw-bold text-muted small">Bölümler</label>
                        <select id="yonetim-bolum-select" class="form-select mb-3" size="5"
                            onchange="bolumSecildiUI()"></select>

                        <!-- İŞLEM BUTONLARI -->
                        <div class="d-flex gap-2 mb-3">
                            <button class="btn btn-primary flex-fill" onclick="toggleBolumEkle()"><i
                                    class="fa fa-plus"></i> Yeni</button>
                            <button id="btn-bolum-duzenle" class="btn btn-warning text-white flex-fill"
                                onclick="toggleBolumDuzenle()" disabled><i class="fa fa-edit"></i> Düzenle</button>
                            <button id="btn-bolum-sil" class="btn btn-danger flex-fill" onclick="bolumSilUI()"
                                disabled><i class="fa fa-trash"></i> Sil</button>
                        </div>

                        <!-- YENİ / DÜZENLE FORM ALANI (Gizli) -->
                        <div id="bolum-islem-form" class="bg-light p-2 rounded border d-none">
                            <input type="hidden" id="bolum-islem-mode"> <!-- 'new' veya 'edit' -->
                            <input type="hidden" id="bolum-eski-ad">
                            <label id="bolum-form-label" class="small fw-bold text-muted">Bölüm Adı</label>
                            <div class="input-group">
                                <input type="text" id="bolum-input-ad" class="form-control" placeholder="Bölüm adı...">
                                <button class="btn btn-success" onclick="bolumKaydetUI()"><i
                                        class="fa fa-save"></i></button>
                                <button class="btn btn-secondary" onclick="toggleBolumForm(false)"><i
                                        class="fa fa-times"></i></button>
                            </div>
                        </div>

                        <hr>
                        <button class="btn btn-info text-white w-100 fw-bold" onclick="openBolumSiralama()"><i
                                class="fa fa-sort"></i> Sıralamayı Değiştir</button>
                    </div>

                    <!-- 2. SIRALAMA EKRANI (Başlangıçta Gizli) -->
                    <div id="bolum-siralama-container" class="d-none mt-2">
                        <div class="alert alert-info small"><i class="fa fa-info-circle"></i> Bölümleri sürükleyip
                            bırakarak sırasını değiştirin.</div>
                        <ul id="bolum-sort-list" class="list-group mb-3"></ul>
                        <div class="d-flex gap-2">
                            <button class="btn btn-secondary w-50" onclick="closeBolumSiralama()">Vazgeç</button>
                            <button class="btn btn-success w-50" onclick="saveBolumSiralamaUI()">Kaydet</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade no-print" id="modal-stok-islem" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content border-0 shadow">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title fw-bold"><i class="fa fa-boxes"></i> Stok Yönetimi</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    <ul class="nav nav-tabs nav-fill" id="stokTabs" role="tablist">
                        <li class="nav-item">
                            <button class="nav-link active fw-bold text-dark" data-bs-toggle="tab"
                                data-bs-target="#tab-transfer" type="button">Transfer</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link fw-bold text-dark" data-bs-toggle="tab" data-bs-target="#tab-iade"
                                type="button">İade Al</button>
                        </li>
                        <li class="nav-item d-none" id="nav-item-giris">
                            <button class="nav-link fw-bold text-success" data-bs-toggle="tab"
                                data-bs-target="#tab-giris" type="button">Giriş</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link fw-bold text-danger" data-bs-toggle="tab" data-bs-target="#tab-zayi"
                                type="button">Zayi</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link fw-bold text-primary" data-bs-toggle="tab"
                                data-bs-target="#tab-gecmis" type="button" onclick="loadStokGecmisi()">Geçmiş</button>
                        </li>
                    </ul>

                    <div class="tab-content p-3">

                        <div class="tab-pane fade show active" id="tab-transfer">
                            <div id="alert-transfer-dergah" class="alert alert-warning d-none">
                                <i class="fa fa-lock"></i> Transfer işlemi için lütfen <b>İl Sorumlunuz</b> ile
                                iletişime geçiniz.
                            </div>
                            <div id="form-transfer">
                                <div class="alert alert-light border small mb-2"><i class="fa fa-info-circle"></i>
                                    Deponuzdaki kutuları alt birime gönderir.</div>
                                <label class="form-label fw-bold">Hedef Birim (Kime?)</label>
                                <select id="stok-transfer-hedef" class="form-select mb-2"></select>
                                <label class="form-label fw-bold">Miktar</label>
                                <input type="number" id="stok-transfer-miktar" class="form-control mb-2"
                                    placeholder="Adet">
                                <label class="form-label fw-bold">Açıklama</label>
                                <input type="text" id="stok-transfer-aciklama" class="form-control mb-3"
                                    placeholder="Örn: Haftalık talep">
                                <button class="btn btn-warning w-100 fw-bold"
                                    onclick="stokIslemiYap('TRANSFER')">TRANSFER ET</button>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="tab-iade">
                            <div id="alert-iade-dergah" class="alert alert-secondary d-none">
                                <i class="fa fa-lock"></i> İade işlemi üst birim tarafından yapılmaktadır. Lütfen <b>İl
                                    Sorumlunuza</b> bilgi veriniz.
                            </div>
                            <div id="form-iade">
                                <div class="alert alert-light border small mb-2"><i class="fa fa-undo"></i> Alt
                                    birimdeki fazla stoğu geri çeker.</div>
                                <label class="form-label fw-bold">Kaynak Birim (Kimden?)</label>
                                <select id="stok-iade-hedef" class="form-select mb-2"></select>
                                <label class="form-label fw-bold">Miktar</label>
                                <input type="number" id="stok-iade-miktar" class="form-control mb-2" placeholder="Adet">
                                <label class="form-label fw-bold">Açıklama</label>
                                <input type="text" id="stok-iade-aciklama" class="form-control mb-3"
                                    placeholder="Örn: Fazla gönderim iadesi">
                                <button class="btn btn-dark w-100 fw-bold" onclick="stokIslemiYap('IADE')">İADE
                                    AL</button>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="tab-giris">
                            <div class="alert alert-success bg-opacity-10 border-success small mb-2"><i
                                    class="fa fa-plus-circle"></i> Dışarıdan/Merkezden depoya giriş.</div>
                            <label class="form-label fw-bold">Miktar</label>
                            <input type="number" id="stok-giris-miktar" class="form-control mb-2" placeholder="Adet">
                            <label class="form-label fw-bold">Açıklama</label>
                            <input type="text" id="stok-giris-aciklama" class="form-control mb-3"
                                placeholder="Örn: Merkezden gelen">
                            <button class="btn btn-success w-100 fw-bold" onclick="stokIslemiYap('GIRIS')">STOK
                                EKLE</button>
                        </div>

                        <div class="tab-pane fade" id="tab-zayi">
                            <div class="alert alert-danger bg-opacity-10 border-danger small mb-2"><i
                                    class="fa fa-trash"></i> Hasarlı/Kayıp kutuları stoktan düşer.</div>
                            <label class="form-label fw-bold">Miktar</label>
                            <input type="number" id="stok-zayi-miktar" class="form-control mb-2" placeholder="Adet">
                            <label class="form-label fw-bold">Sebep</label>
                            <input type="text" id="stok-zayi-aciklama" class="form-control mb-3"
                                placeholder="Örn: Su baskını, yırtık">
                            <button class="btn btn-danger w-100 fw-bold" onclick="stokIslemiYap('ZAYI')">DÜŞÜM
                                YAP</button>
                        </div>

                        <div class="tab-pane fade" id="tab-gecmis">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <small class="text-muted">Stok hareket tarihçesi</small>
                                <select id="stok-gecmis-yil" class="form-select form-select-sm w-auto"
                                    onchange="loadStokGecmisi()">
                                    <option value="Tümü">Tümü</option>
                                    <option value="2026" selected>2026</option>
                                    <option value="2025">2025</option>
                                </select>
                            </div>
                            <div class="table-responsive border rounded" style="max-height: 300px;">
                                <table class="table table-sm table-striped mb-0" style="font-size:0.8rem;">
                                    <thead class="table-light sticky-top">
                                        <tr>
                                            <th>Tarih</th>
                                            <th>İşlem</th>
                                            <th>Miktar</th>
                                            <th>Kaynak/Hedef</th>
                                            <th>Açıklama</th>
                                        </tr>
                                    </thead>
                                    <tbody id="stok-gecmis-tbody">
                                        <tr>
                                            <td colspan="5" class="text-center p-3">Yükleniyor...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modal-tum-liste" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">
                <div class="modal-header bg-dark text-white no-print">
                    <h5 class="modal-title"><i class="fa fa-list-ul"></i> Tüm Dükkan Listesi</h5>
                    <div>
                        <button class="btn btn-light btn-sm me-2" onclick="window.print()"><i class="fa fa-print"></i>
                            Yazdır</button>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                            aria-label="Kapat"></button>
                    </div>
                </div>
                <div class="modal-body p-4 bg-light">
                    <div id="tum-liste-baslik" class="text-center mb-4 pb-2 border-bottom border-dark"
                        style="display:none;"></div>
                    <div id="tum-liste-container" class="container bg-white p-3 rounded shadow-sm">
                        <div class="text-center text-muted">Yükleniyor...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="main-container">
        <div class="kutu-header d-flex justify-content-between align-items-center">
            <div>
                <h5 class="m-0 fw-bold"><i class="fa fa-box-open me-2"></i>Kutu Takip</h5>
                <small id="user-display" style="opacity: 0.9; font-size: 0.85rem;">Yükleniyor...</small>
            </div>

            <div class="header-icons-wrapper">
                <div class="header-icon-btn" onclick="window.location.href='index.html'" title="Ana Sayfa"
                    style="padding: 0; overflow: hidden; display: flex; align-items: center; justify-content: center;">

                    <img src="https://raw.githubusercontent.com/buhara54/zikirtakip/main/icon-192.png"
                        style="width: 100%; height: 100%; object-fit: cover; transform: scale(1.3);">
                </div>

                <img src="https://raw.githubusercontent.com/buhara54/zikirtakip/main/logolar/bhrlg.jpg"
                    class="header-icon-btn"
                    onclick="window.location.href='https://script.google.com/macros/s/AKfycbyN6UOTS9mM9KXWRfGxf3Snlg3U9s2s-SoVIZ7hX46on3f_vTJnw-GUTalad1LAny2i/exec?sayfa=portal'"
                    title="Yönetim Portalı">
            </div>
        </div>
        <div id="kutu-dashboard" class="container-fluid px-3 d-none">
            <div class="row g-3 text-center mb-4">
                <div class="col-4">
                    <div class="dash-card">
                        <div class="dash-label">Aktif</div>
                        <div id="dash-saha" class="dash-val text-primary">-</div>
                    </div>
                </div>
                <div class="col-4">
                    <div class="dash-card">
                        <div class="dash-label">Ziyaret</div>
                        <div id="dash-ziyaret" class="dash-val text-success">-</div>
                    </div>
                </div>
                <div class="col-4">
                    <div class="dash-card">
                        <div class="dash-label">Stok</div>
                        <div id="dash-stok" class="dash-val text-warning">-</div>
                    </div>
                </div>
            </div>

            <div class="progress-container">
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <span class="text-muted small fw-bold">GENEL PERFORMANS</span>
                </div>
                <div class="custom-progress">
                    <div id="main-progress-bar" class="custom-bar bg-low" role="progressbar">0%</div>
                </div>
                <small class="text-muted mt-2 d-block" style="font-size: 0.75rem;">
                    Toplam <span id="lbl-toplam-dukkan">0</span> dükkandan <span id="lbl-gidilen-dukkan">0</span> tanesi
                    ziyaret edildi.
                </small>
            </div>

            <div class="row g-3">
                <div class="col-6">
                    <button onclick="kutuEkranDegistir('ekran-ziyaret')" class="menu-btn btn-ziyaret">
                        <i class="fa fa-clipboard-check fa-2x"></i>
                        <span>Ziyaret</span>
                    </button>
                </div>
                <div class="col-6">
                    <button onclick="openStokModal()" class="menu-btn btn-stok">
                        <i class="fa fa-box-open fa-2x"></i>
                        <span>Stok</span>
                    </button>
                </div>
                <div class="col-6">
                    <button onclick="kutuEkranDegistir('ekran-rapor')" class="menu-btn btn-rapor">
                        <i class="fa fa-chart-pie fa-2x"></i>
                        <span>Raporlar</span>
                    </button>
                </div>
                <div class="col-6">
                    <button onclick="kutuEkranDegistir('ekran-duzenle')" class="menu-btn btn-duzenle">
                        <i class="fa fa-edit fa-2x"></i>
                        <span>Düzenle</span>
                    </button>
                </div>

                <div class="col-6">
                    <button onclick="tumListeyiGoster()" class="btn-full-list">
                        <i class="fa fa-list-ul fa-lg"></i>
                        <span>TÜM LİSTE</span>
                    </button>
                </div>
                <div class="col-6">
                    <button onclick="loadPasifDukkanlar()" class="btn-full-list bg-secondary">
                        <i class="fa fa-user-slash fa-lg"></i>
                        <span>PASİF LİSTE</span>
                    </button>
                </div>
            </div>
        </div>

        <div class="modal fade no-print" id="modal-pasif" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
                <div class="modal-content border-0 shadow">
                    <div class="modal-header bg-secondary text-white">
                        <h5 class="modal-title"><i class="fa fa-user-slash"></i> Pasif Dükkanlar</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body p-0">
                        <div id="pasif-liste-container" class="list-group list-group-flush">
                            <div class="text-center p-3 text-muted">Yükleniyor...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="ekran-ziyaret" class="container-fluid px-3 d-none">
            <div class="d-flex justify-content-between mb-3 align-items-center">
                <button class="btn btn-outline-secondary rounded-pill px-3"
                    onclick="kutuEkranDegistir('kutu-dashboard')"><i class="fa fa-arrow-left me-1"></i> Geri</button>
                <button class="btn btn-primary rounded-pill px-4" onclick="ziyaretIslemiBaslat()"> KAYDET <i
                        class="fa fa-save ms-1"></i></button>
            </div>

            <div class="card p-2 text-center mb-3 bg-white border-0 shadow-sm">
                <div class="d-flex justify-content-between align-items-center">
                    <button class="btn btn-sm btn-light rounded-circle border" onclick="rotaDegistir(-1)"
                        style="width:36px;height:36px;"><i class="fa fa-chevron-left"></i></button>
                    <strong id="lbl-aktif-rota" class="text-primary">Yükleniyor...</strong>
                    <button class="btn btn-sm btn-light rounded-circle border" onclick="rotaDegistir(1)"
                        style="width:36px;height:36px;"><i class="fa fa-chevron-right"></i></button>
                </div>
            </div>

            <div id="liste-container" class="list-group shadow-sm mb-4">
                <div class="text-center p-3 text-muted">Rota yükleniyor...</div>
            </div>
        </div>

        <div id="ekran-rapor" class="container-fluid px-3 d-none">
            <div class="d-flex justify-content-between mb-3 no-print">
                <button id="btn-rapor-geri" class="btn btn-outline-secondary rounded-pill px-3"
                    onclick="kutuEkranDegistir('kutu-dashboard')"><i class="fa fa-arrow-left me-1"></i> Geri</button>
                <button class="btn btn-outline-dark rounded-pill px-3" onclick="raporYazdir()"><i
                        class="fa fa-print me-1"></i> Yazdır</button>
                <div id="ust-birim-kontroller" class="container mt-2 mb-2 d-none"><button
                        class="btn btn-warning w-100 fw-bold shadow-sm" onclick="openStokModal()">
                        <i class="fa fa-boxes me-2"></i>STOK İŞLEMLERİ</button></div>
            </div>

            <div class="card p-3 mb-3 border-0 shadow-sm no-print">
                <h6 class="text-primary border-bottom pb-2 mb-3">Dönem Raporu</h6>
                <div class="input-group mb-4">
                    <select id="rapor-ay" class="form-select bg-light">
                        <option value="1">Ocak</option>
                        <option value="2">Şubat</option>
                        <option value="3">Mart</option>
                        <option value="4">Nisan</option>
                        <option value="5">Mayıs</option>
                        <option value="6">Haziran</option>
                        <option value="7">Temmuz</option>
                        <option value="8">Ağustos</option>
                        <option value="9">Eylül</option>
                        <option value="10">Ekim</option>
                        <option value="11">Kasım</option>
                        <option value="12">Aralık</option>
                    </select>
                    <select id="rapor-yil" class="form-select bg-light">
                        <option value="2025">2025</option>
                        <option value="2026">2026</option>
                    </select>
                    <button class="btn btn-primary" onclick="loadKutuRapor()" title="Aylık Rapor Getir"><i
                            class="fa fa-chart-bar me-1"></i> AYLIK</button>
                    <button class="btn btn-dark" onclick="loadYillikRapor()" title="Yıllık Matris Rapor"><i
                            class="fa fa-table me-1"></i> YILLIK</button>
                </div>

                <h6 class="text-danger border-bottom pb-2 mb-3">Unutulanlar</h6>
                <div class="input-group">
                    <input type="number" id="ihmal-gun" class="form-control bg-light" value="30" placeholder="Gün">
                    <button class="btn btn-outline-danger" onclick="ihmalGetir()">Tara</button>
                </div>
            </div>

            <div id="rapor-sonuc" class="pb-5">
                <div class="text-center text-muted p-4">Rapor seçimi yapınız.</div>
            </div>
        </div>

        <div id="ekran-duzenle" class="container-fluid px-3 d-none">
            <div class="d-flex justify-content-between mb-3">
                <button class="btn btn-outline-secondary rounded-pill px-3"
                    onclick="kutuEkranDegistir('kutu-dashboard')"><i class="fa fa-arrow-left me-1"></i> Geri</button>
            </div>

            <div class="card p-3 mb-3 border-0 shadow-sm">
                <div class="row g-2">
                    <div class="col-12">
                        <div class="input-group">
                            <select id="edit-bolum-select" class="form-select" onchange="editBolumSecildi()">
                                <option value="">Bölüm Seçiniz...</option>
                            </select>
                            <button class="btn btn-outline-secondary" onclick="bolumYonetimiAc()"
                                title="Bölüm Ayarları">
                                <i class="fa fa-cog"></i>
                            </button>
                        </div>
                    </div>

                    <div class="col-12">
                        <select id="edit-dukkan-select" class="form-select">
                            <option value="">Önce Bölüm Seçiniz</option>
                        </select>
                    </div>

                    <div class="col-12 d-flex gap-2 mt-2">
                        <button class="btn btn-primary flex-fill" onclick="duzenleButonu()"
                            title="Seçiliyi Düzenle">DÜZENLE</button>
                        <button class="btn btn-success" onclick="yeniButonu()" title="Yeni Dükkan Ekle"><i
                                class="fa fa-plus"></i></button>
                        <button class="btn btn-warning text-white" onclick="siralaModuAc()"
                            title="Sıralamayı Değiştir"><i class="fa fa-sort"></i></button>
                    </div>
                </div>
            </div>

            <div id="edit-form-container" class="card p-3 mb-3 border-0 shadow-sm d-none"
                style="background:#f8f9fa; border-left:4px solid #0d6efd !important;">
                <h6 class="text-primary mb-3"><i class="fa fa-edit"></i> Dükkan Bilgileri</h6>
                <input type="hidden" id="form-id">

                <div class="mb-2">
                    <label class="small text-muted fw-bold">Bölüm (Rota)</label>
                    <select id="form-bolum" class="form-select"></select>
                </div>

                <div class="mb-2">
                    <label class="small text-muted fw-bold">Dükkan Adı</label>
                    <input type="text" id="form-dukkan" class="form-control" placeholder="Dükkanın tabelası...">
                </div>

                <div class="row g-2 mb-2">
                    <div class="col-6">
                        <label class="small text-muted fw-bold">Dükkan Sahibi</label>
                        <input type="text" id="form-sahibi" class="form-control" placeholder="Müşteri Adı">
                    </div>
                    <div class="col-6">
                        <label class="small text-muted fw-bold">Telefon</label>
                        <input type="text" id="form-telefon" class="form-control" placeholder="05...">
                    </div>
                </div>

                <div class="mb-2">
                    <label class="small text-muted fw-bold">Bırakan</label>
                    <input type="text" id="form-sorumlu" class="form-control" placeholder="Kutuyu bırakan kişi">
                </div>

                <div class="mb-2">
                    <label class="small text-muted fw-bold">Adres</label>
                    <input type="text" id="form-adres" class="form-control">
                </div>

                <div class="mb-3">
                    <label class="small text-muted fw-bold">Detay / Not</label>
                    <textarea id="form-detay" class="form-control" rows="2"></textarea>
                </div>

                <div class="d-flex gap-2">
                    <button class="btn btn-success flex-fill" onclick="kaydetForm()">KAYDET</button>
                    <button class="btn btn-danger" onclick="silForm()"><i class="fa fa-trash"></i></button>
                    <button class="btn btn-secondary" onclick="formKapat()">İptal</button>
                </div>
            </div>

            <div id="sort-container" class="card p-3 mb-3 border-0 shadow-sm d-none">
                <h6 class="text-warning mb-3"><i class="fa fa-sort"></i> Sıralama Modu</h6>
                <div class="alert alert-info small py-1"><i class="fa fa-info-circle"></i> Sürükleyip bırakın, sonra
                    kaydedin.</div>

                <ul id="sort-list" class="list-group mb-3"></ul>

                <div class="d-flex gap-2">
                    <button class="btn btn-primary flex-fill" onclick="siralaKaydet()">Sıralamayı Kaydet</button>
                    <button class="btn btn-secondary" onclick="sortKapat()">Kapat</button>
                </div>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <script>
            const API_URL = "https://script.google.com/macros/s/AKfycbyN6UOTS9mM9KXWRfGxf3Snlg3U9s2s-SoVIZ7hX46on3f_vTJnw-GUTalad1LAny2i/exec";
            let currentUser = null, aktifRota = "", rotaListesi = [];
            let globalBaslikBilgi = null; // YENİ: Başlık bilgisini hafızada tutacak değişken
            let sonEklenenBolum = null;   // YENİ: Henüz dükkanı olmayan yeni bölümü hafızada tutar

            // --- ALTYAPI ---
            async function run(islem, data) {
                try {
                    const res = await fetch(API_URL, {
                        method: "POST",
                        headers: { "Content-Type": "text/plain;charset=utf-8" },
                        body: JSON.stringify({ islem, ...data })
                    });
                    return await res.json();
                } catch (e) {
                    console.error("API Hatası:", e);
                    ozelAlert("Bağlantı Hatası: " + e.message, "Hata");
                    return null;
                }
            }

            // --- ÖZEL ALERT (MODAL) ---
            function ozelAlert(mesaj, baslik = "Bilgi", onConfirm = null) {
                const modalEl = document.getElementById('ozelAlertModal');
                const body = document.getElementById('ozelAlertBody');
                const header = document.getElementById('ozelAlertHeader');
                const btnOk = document.getElementById('btnAlertOk');
                const btnCancel = document.getElementById('btnAlertCancel');

                body.innerHTML = mesaj;
                header.className = "modal-header text-white " +
                    (baslik === "Hata" ? "bg-danger" : (baslik === "Dikkat" ? "bg-warning text-dark" : "bg-primary"));

                const newBtnOk = btnOk.cloneNode(true);
                btnOk.parentNode.replaceChild(newBtnOk, btnOk);
                const newBtnCancel = btnCancel.cloneNode(true);
                btnCancel.parentNode.replaceChild(newBtnCancel, btnCancel);

                // LOADING MODU: Butonları Gizle
                if (onConfirm === 'loading') {
                    newBtnOk.style.display = 'none';
                    newBtnCancel.style.display = 'none';
                    // Kapatma engelleme (dışarı tıklama vs.)
                    const m = new bootstrap.Modal(modalEl, { backdrop: 'static', keyboard: false });
                    m.show();
                    return;
                }

                if (onConfirm && typeof onConfirm === 'function') {
                    newBtnCancel.style.display = 'block';
                    newBtnOk.style.display = 'block'; // Ensure OK is visible
                    newBtnOk.innerHTML = "Tamam";     // Reset text if needed
                    newBtnOk.onclick = () => {
                        bootstrap.Modal.getInstance(modalEl).hide();
                        onConfirm();
                    };
                } else {
                    newBtnCancel.style.display = 'none';
                    newBtnOk.style.display = 'block';
                    newBtnOk.innerHTML = "Tamam";
                    newBtnOk.onclick = () => {
                        bootstrap.Modal.getInstance(modalEl).hide();
                    };
                }

                // Mevcut instance varsa onu kullan, yoksa yeni oluştur
                let bsModal = bootstrap.Modal.getInstance(modalEl);
                if (!bsModal) bsModal = new bootstrap.Modal(modalEl);
                bsModal.show();
            }

            function closeOzelAlert() {
                const el = document.getElementById('ozelAlertModal');
                const instance = bootstrap.Modal.getInstance(el);
                if (instance) instance.hide();
            }

            // --- BAŞLANGIÇ ---
            window.onload = function () {
                const u = new URLSearchParams(window.location.search).get('user') || localStorage.getItem('buhara_user');
                if (u) {
                    try {
                        currentUser = (typeof u === 'string' && u.includes('{')) ? JSON.parse(u) : { email: decodeURIComponent(u) };
                        document.getElementById('user-display').innerText = currentUser.email;
                        baslat();
                    } catch (e) { ozelAlert("Kullanıcı verisi bozuk.", "Hata"); }
                } else {
                    ozelAlert("Lütfen sisteme giriş yapınız.", "Hata");
                }
            };

            function baslat() {
                // 1. YÜKLENİYOR EKRANI (GÜVENLİ YÖNTEM)
                // Header'ı silmeden, altına geçici bir yükleme ekranı ekliyoruz.
                const mainContainer = document.getElementById('main-container');
                const loaderId = 'global-loading-screen';

                // Eğer zaten ekli değilse ekle
                if (mainContainer && !document.getElementById(loaderId)) {
                    const loadingHTML = `
            <div id="${loaderId}" class="d-flex flex-column justify-content-center align-items-center" style="height: 60vh;">
                <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                    <span class="visually-hidden">Yükleniyor...</span>
                </div>
                <h5 class="mt-4 text-secondary fw-bold">Veriler Hazırlanıyor...</h5>
                <div class="text-muted small">Lütfen bekleyiniz</div>
            </div>`;

                    // 'beforeend' diyerek Header'ın sonrasına (en alta) ekliyoruz.
                    mainContainer.insertAdjacentHTML('beforeend', loadingHTML);
                }

                // 2. VERİLERİ ÇEK
                run('kutu_dashboard', { username: currentUser.email }).then(res => {
                    // Veri geldi, Yükleme ekranını kaldır
                    const loader = document.getElementById(loaderId);
                    if (loader) loader.remove();
                    // --- GÜNCELLEME BAŞLANGICI ---
                    if (res) {
                        // 1. Yetkiyi Al
                        if (res.yetki) currentUser.yetki = res.yetki;
                        // 2. KİMLİK BİLGİLERİNİ MEVCUT STANDARTTAN (baslikBilgi) AL
                        // Backend hibrit değil, biz ona uyuyoruz.
                        if (res.baslikBilgi) { currentUser.bolge = res.baslikBilgi.bolge; currentUser.il = res.baslikBilgi.il; currentUser.dergah = res.baslikBilgi.dergah; }
                        // 3. Stok Yetkisini Al
                        if (res.stokManuelYetki) currentUser.stokManuelYetki = res.stokManuelYetki;

                        const saha = res.saha || 0;
                        const ziyaret = res.ziyaret || 0;

                        document.getElementById('dash-saha').innerText = saha;
                        document.getElementById('dash-ziyaret').innerText = ziyaret;
                        document.getElementById('dash-stok').innerText = res.stok || 0;

                        if (res.userDisplay) document.getElementById('user-display').innerText = res.userDisplay;
                        if (res.baslikBilgi) globalBaslikBilgi = res.baslikBilgi;

                        updateProgressBar(ziyaret, saha);
                        document.getElementById('lbl-toplam-dukkan').innerText = saha;
                        document.getElementById('lbl-gidilen-dukkan').innerText = ziyaret;

                        // --- YÖNLENDİRME VE ARAYÜZ AYARI ---
                        if (res.yetki === 'il' || res.yetki === 'bolge' || res.yetki === 'merkez') {
                            // 1. Yetkili ise Rapor Ekranını Aç
                            kutuEkranDegistir('ekran-rapor');

                            // 2. Stok Butonunu Peşinen Göster (Rapora bağlı kalmasın)
                            const btnContainer = document.getElementById('ust-birim-kontroller');
                            if (btnContainer) btnContainer.classList.remove('d-none');

                            // 3. Raporu Yükle
                            loadKutuRapor();
                        } else {
                            // Dergah ise Dashboard'u Aç
                            kutuEkranDegistir('kutu-dashboard');
                        }
                        // -------------------------------------
                    }
                });

                run('kutu_akis_getir', { username: currentUser.email }).then(res => {
                    if (res) {
                        rotaListesi = res;
                        if (res.length > 0) rotaSec(res[0]); // İlkini seç
                    }
                });

                const d = new Date();
                document.getElementById('rapor-ay').value = d.getMonth() + 1;
                document.getElementById('rapor-yil').value = d.getFullYear();
            }
            function updateProgressBar(ziyaret, toplam) {
                const bar = document.getElementById('main-progress-bar');
                let yuzde = 0;
                if (toplam > 0) yuzde = Math.round((ziyaret / toplam) * 100);

                bar.style.width = `${yuzde}%`;
                bar.innerText = `%${yuzde}`;

                bar.classList.remove('bg-low', 'bg-mid', 'bg-high');
                if (yuzde < 50) bar.classList.add('bg-low');
                else if (yuzde < 80) bar.classList.add('bg-mid');
                else bar.classList.add('bg-high');
            }

            // --- TAM LİSTE GÖSTER (DÜZELTİLDİ: Mevcut Backend Fonksiyonu Kullanılıyor) ---
            function tumListeyiGoster() {
                const modalEl = document.getElementById('modal-tum-liste');
                const modal = new bootstrap.Modal(modalEl);
                modal.show();

                const div = document.getElementById('tum-liste-container');
                const baslikDiv = document.getElementById('tum-liste-baslik');

                div.innerHTML = '<div class="text-center p-4"><div class="spinner-border text-primary"></div></div>';
                baslikDiv.style.display = 'none';

                // 1. BAŞLIK: Hafızadaki veriyi kullan
                if (globalBaslikBilgi) {
                    const b = globalBaslikBilgi;
                    baslikDiv.innerHTML = `<h5 class="fw-bold m-0 text-uppercase">
            ${b.bolge}. BÖLGE ${b.il || ''} ${b.dergah || ''} DÜKKAN LİSTESİ
         </h5>`;
                    baslikDiv.style.display = 'block';
                } else {
                    baslikDiv.innerHTML = '<h5 class="fw-bold m-0">DÜKKAN LİSTESİ</h5>';
                    baslikDiv.style.display = 'block';
                }

                // 2. VERİ: Mevcut 'kutu_rehber_getir' fonksiyonunu çağırıyoruz
                run('kutu_rehber_getir', { username: currentUser.email }).then(res => {
                    if (!res || !Array.isArray(res) || res.length === 0) {
                        div.innerHTML = '<div class="alert alert-warning">Liste boş veya alınamadı.</div>';
                        return;
                    }

                    // Gruplama
                    const gruplar = {};
                    res.forEach(d => {
                        if (!gruplar[d.bolum]) gruplar[d.bolum] = [];
                        gruplar[d.bolum].push(d);
                    });

                    let html = "";
                    Object.keys(gruplar).sort().forEach(bolumAdi => {
                        const liste = gruplar[bolumAdi];
                        html += `
            <div class="card mb-3 border shadow-sm">
                <div class="card-header bg-secondary text-white fw-bold">
                    ${bolumAdi} (${liste.length})
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0" style="font-size:0.9rem;">
                        <thead class="table-light">
                            <tr>
                                <th>Dükkan</th>
                                <th>Sahibi</th>
                                <th>Tel</th>
                                <th>Adres/Detay</th>
                            </tr>
                        </thead>
                        <tbody>`;

                        liste.forEach(item => {
                            html += `
                    <tr>
                        <td class="fw-bold">${item.dukkan || '-'}</td>
                        <td>${item.sahibi || '-'}</td>
                        <td><a href="tel:${item.telefon}" class="text-decoration-none">${item.telefon || '-'}</a></td>
                        <td class="small text-muted">
                            ${item.adres ? item.adres + '<br>' : ''}
                            ${item.detay || ''}
                        </td>
                    </tr>`;
                        });
                        html += `</tbody></table></div></div>`;
                    });
                    div.innerHTML = html;
                });
            }

            function kutuEkranDegistir(targetId) {
                const screens = ['kutu-dashboard', 'ekran-ziyaret', 'ekran-rapor', 'ekran-stok', 'ekran-duzenle'];
                screens.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) {
                        if (id === targetId) el.classList.remove('d-none');
                        else el.classList.add('d-none');
                    }
                });

                if (targetId === 'ekran-duzenle') ekranDuzenleHazirla();

                // YENİ: Dergah Kullanıcısı İçin Yıllık Rapor Butonunu Gizle
                if (targetId === 'ekran-rapor') {
                    const btnYillik = document.querySelector("button[onclick='loadYillikRapor()']");
                    if (btnYillik) {
                        if (currentUser && currentUser.yetki === 'dergah') {
                            btnYillik.classList.add('d-none');
                        } else {
                            btnYillik.classList.remove('d-none');
                        }
                    }
                }
            }

            function rotaSec(rotaObj) {
                // rotaObj artık {ad: "A Mah", puan: 1} şeklinde nesne olabilir veya eski sistem string olabilir.
                // Uyumluluk kontrolü:
                const rotaAdi = (typeof rotaObj === 'object') ? rotaObj.ad : rotaObj;
                const rotaPuan = (typeof rotaObj === 'object') ? rotaObj.puan : "";

                aktifRota = rotaAdi;

                // HEADER GÜNCELLEME: "1. A MAHALLESİ" formatı
                const baslikText = (rotaPuan && rotaPuan != 9999) ? `${rotaPuan}. ${rotaAdi}` : rotaAdi;
                document.getElementById('lbl-aktif-rota').innerText = baslikText;

                const container = document.getElementById('liste-container');
                container.innerHTML = '<div class="text-center p-4"><div class="spinner-border text-primary"></div></div>';

                // TÜMÜNÜ SEÇ BUTONU EKLE (Liste Başına)
                // Konteyner temizlenmeden önce buton alanı ekleyelim veya konteyner içine en başa koyalım.
                // Biz listenin hemen üstüne (liste-container içine değil, üstüne) koymak yerine
                // liste içine en tepeye koyabiliriz.

                run('kutu_liste_getir', { akis: rotaAdi, username: currentUser.email }).then(res => {
                    container.innerHTML = "";
                    if (!res || res.length === 0) {
                        container.innerHTML = '<div class="alert alert-warning m-3">Bu rotada dükkan bulunamadı.</div>';
                        return;
                    }

                    // -- TÜMÜNÜ SEÇ ALANI --
                    const selectAllDiv = document.createElement('div');
                    selectAllDiv.className = "d-flex justify-content-end px-3 py-2 border-bottom bg-light";
                    selectAllDiv.innerHTML = `
                        <button class="btn btn-sm btn-outline-primary fw-bold" onclick="tumunuSecToggle(this)">
                            <i class="fa fa-check-double"></i> Tümünü Seç
                        </button>
                    `;
                    container.appendChild(selectAllDiv);
                    // -----------------------

                    res.forEach(d => {
                        const bgClass = d.bugunGidildi ? "bg-success-subtle" : "bg-white";
                        const checkedAttr = d.bugunGidildi ? "checked disabled" : "";

                        // İSİM TEMİZLİĞİ: "1. A Market" -> "A Market"
                        // Genelde d.dukkan verisi temiz gelir ama eğer "1.2 Dükkan" formatındaysa temizleyelim
                        // Kullanıcı isteği: "Dükkan dükkanlarının başına 1.2 gibi sayılar geliyor bunları kaldıracağız"
                        // Bu sayılar d.altSira olabilir. liste ekranında d.altSira + d.dukkan gösteriliyordu.

                        // ESKİ KOD: <span class="fw-bold text-dark">${d.altSira || d.sira}. ${d.dukkan}</span>
                        // YENİ KOD: Sadece ${d.dukkan}

                        const item = document.createElement('label');
                        item.className = `list-group-item d-flex justify-content-between align-items-center ${bgClass}`;
                        item.style.cursor = "pointer";
                        item.innerHTML = `
                <div>
                     <span class="fw-bold text-dark">${d.dukkan}</span>
                    <br><small class="text-muted">${d.detay || ''}</small>
                </div>
                <div class="form-check">
                    <input class="form-check-input ziyaret-cb" type="checkbox" value="${d.id}" ${checkedAttr} style="width: 1.8em; height: 1.8em;">
                </div>
            `;
                        container.appendChild(item);
                    });
                });
            }

            function tumunuSecToggle(btn) {
                const checkboxes = document.querySelectorAll('.ziyaret-cb:not(:disabled)');
                const allChecked = Array.from(checkboxes).every(cb => cb.checked);

                checkboxes.forEach(cb => cb.checked = !allChecked);

                if (!allChecked) {
                    btn.innerHTML = '<i class="fa fa-times"></i> Seçimi Kaldır';
                    btn.className = "btn btn-sm btn-outline-danger fw-bold";
                } else {
                    btn.innerHTML = '<i class="fa fa-check-double"></i> Tümünü Seç';
                    btn.className = "btn btn-sm btn-outline-primary fw-bold";
                }
            }

            function rotaDegistir(yon) {
                if (rotaListesi.length === 0) return;

                // Rota listesi artık obje dizisi veya string dizisi olabilir.
                // Aktif rotayı bulmak için karşılaştırma yapmalıyız.
                let currentIndex = -1;

                // Obje mi string mi kontrolü
                const isObject = (typeof rotaListesi[0] === 'object');

                if (isObject) {
                    currentIndex = rotaListesi.findIndex(r => r.ad === aktifRota);
                } else {
                    currentIndex = rotaListesi.indexOf(aktifRota);
                }

                let yeniIndex = currentIndex + yon;
                if (yeniIndex < 0) yeniIndex = rotaListesi.length - 1;
                if (yeniIndex >= rotaListesi.length) yeniIndex = 0;

                rotaSec(rotaListesi[yeniIndex]);
            }

            function ziyaretIslemiBaslat() {
                const checkboxes = document.querySelectorAll('.ziyaret-cb:checked:not(:disabled)');
                const allCheckboxes = document.querySelectorAll('.ziyaret-cb:not(:disabled)');

                const ids = Array.from(checkboxes).map(c => c.value);
                const isAllSelected = (checkboxes.length === allCheckboxes.length) && (allCheckboxes.length > 0);

                if (ids.length === 0) return ozelAlert("Lütfen en az bir dükkan seçiniz.");

                // 1. EKSİK SEÇİM KONTROLÜ
                if (!isAllSelected) {
                    const msg = `<div class="alert alert-secondary">
                        <strong>Bilgi:</strong> Bölümdeki tüm dükkanları seçmediniz.<br><br>
                        Seçili ${ids.length} dükkan, Toplam ${allCheckboxes.length} dükkan.
                        </div><p>Sadece seçtiklerinizi kaydetmek istiyor musunuz?</p>`;

                    ozelAlert(msg, "Dikkat", () => adimIkiTarihKontrol(ids));
                } else {
                    // Hepsi seçiliyse direkt 2. adıma geç
                    adimIkiTarihKontrol(ids);
                }
            }

            function adimIkiTarihKontrol(ids) {
                ozelAlert("Kontrol ediliyor...", "Bilgi", 'loading'); // Loading modu

                run('kutu_10gun_kontrol', { ids: ids, username: currentUser.email }).then(uyariListesi => {
                    // Loading modalını kapat (ya da içeriği güncellemek için beklet)
                    // ozelAlert iç yapısında loading kapatma var mı? 
                    // Bootstrap modal'i manuel kapatalım en temizi
                    closeOzelAlert();

                    if (uyariListesi && uyariListesi.length > 0) {
                        // Gecikmeli açalım ki modal animasyonları karışmasın
                        setTimeout(() => {
                            const msg = `
                    <div class="alert alert-warning mb-2"><strong>Dikkat! Yakın zamanda kaydı var:</strong></div>
                    <ul class="mb-3 small text-start" style="max-height:150px; overflow-y:auto;"><li>${uyariListesi.join('</li><li>')}</li></ul>
                    <p class="mb-0 fw-bold">Yine de kaydetmek istiyor musunuz?</p>
                `;
                            ozelAlert(msg, "Dikkat", () => kaydiTamamla(ids));
                        }, 300);
                    } else {
                        kaydiTamamla(ids);
                    }
                });
            }

            function kaydiTamamla(ids) {
                const d = new Date();
                const tarihStr = `${String(d.getDate()).padStart(2, '0')}.${String(d.getMonth() + 1).padStart(2, '0')}.${d.getFullYear()}`;

                // LOADING: Kaydediliyor... Mesajı (Ve gitmeyecek)
                ozelAlert(`<div class="text-center"><div class="spinner-border text-success mb-2"></div><br>Kaydediliyor...</div>`, "Bilgi", 'loading');

                run('kutu_ziyaret_kaydet', { ids: ids, tarih: tarihStr, username: currentUser.email }).then(res => {
                    // Modal hala açık. Şimdi içeriği güncelleyeceğiz.
                    closeOzelAlert(); // Öncekini kapat

                    if (res && res.basarili) {
                        // BAŞARILI
                        setTimeout(() => {
                            ozelAlert("✅ " + res.mesaj, "Bilgi");
                        }, 200);

                        // YÖNLENDİRME YOK! AYNI SAYFADA KAL
                        // Sadece listeyi güncelle (seçimleri temizle ve disable yap)
                        // rotaSec çağırırsak reload olur, en temizi bu.
                        // İsterseniz aktifRota adıyla yeniden çağırın ama bu sefer backend nesne bekliyor olabilir mi?
                        // rotaSec fonksiyonumuz hem nesne hem string kabul ediyor, sorun yok.

                        // Aktif rotanın nesne mi string mi olduğunu bulup tekrar gönderelim
                        const currentObj = rotaListesi.find(r => (r.ad === aktifRota || r === aktifRota));
                        if (currentObj) rotaSec(currentObj); // Listeyi tazele

                    } else {
                        // HATA
                        setTimeout(() => {
                            ozelAlert("Hata: " + (res ? res.mesaj : "Bilinmeyen hata"), "Hata");
                        }, 200);
                    }
                });
            }

            function loadKutuRapor() {
                const ay = document.getElementById('rapor-ay').value;
                const yil = document.getElementById('rapor-yil').value;
                const div = document.getElementById('rapor-sonuc');

                // BUTONU SEÇİYORUZ
                const btnGeri = document.getElementById('btn-rapor-geri');

                div.innerHTML = '<div class="text-center p-4"><div class="spinner-border text-primary"></div><div class="mt-2">Rapor hazırlanıyor...</div></div>';

                // LOG 1: Yetki ve Buton Durumu Kontrolü (HATA BURADA GÖRÜNECEK)
                console.log("--- GERİ TUŞU KONTROLÜ ---");
                console.log("Kullanıcı Yetkisi:", currentUser ? currentUser.yetki : "Kullanıcı Yok");
                console.log("Buton Bulundu mu?:", btnGeri ? "EVET" : "HAYIR (HTML'de ID eksik)");

                if (btnGeri) {
                    // Eğer kullanıcı yönetici ise (il, bolge, merkez) geri tuşunu gizle
                    if (currentUser.yetki === 'il' || currentUser.yetki === 'bolge' || currentUser.yetki === 'merkez') {
                        console.log(">> Karar: Buton GİZLENİYOR");
                        btnGeri.classList.add('d-none');
                    } else {
                        console.log(">> Karar: Buton GÖSTERİLİYOR");
                        btnGeri.classList.remove('d-none');
                    }
                } else {
                    console.warn("UYARI: 'btn-rapor-geri' ID'li buton sayfada bulunamadı!");
                }

                // LOG 2: İsteği Göster
                console.log("Rapor İsteği Gönderiliyor:", { ay, yil, user: currentUser.email });

                run('kutu_rapor_getir', { ay, yil, username: currentUser.email }).then(res => {
                    // LOG 3: Gelen Cevabı Göster
                    console.log("Sunucudan Gelen Rapor Cevabı:", res);
                    renderRaporTablosu(res);
                });
            }

            /* --- ADIM 2: Rapor Tablosunu Çizen Fonksiyon (SÖZDİZİMİ VE BAŞLIK DÜZELTİLDİ) --- */
            function renderRaporTablosu(res) {
                // 1. DIV TANIMLAMASI (Sadece burada tanımlı, aşağıda tekrar etmeyecek)
                const div = document.getElementById('rapor-sonuc');

                if (!div) {
                    console.error("Hata: 'rapor-sonuc' ID'li div bulunamadı.");
                    return;
                }

                div.innerHTML = "";

                // --- BAŞLIK ALANI (DİNAMİK VE HİYERARŞİK) ---
                try {
                    const ayInput = document.getElementById('rapor-ay');
                    const yilInput = document.getElementById('rapor-yil');
                    const ayAdlari = ["", "Ocak", "Şubat", "Mart", "Nisan", "Mayıs", "Haziran", "Temmuz", "Ağustos", "Eylül", "Ekim", "Kasım", "Aralık"];

                    let baslikMetni = "";

                    if (typeof currentUser !== 'undefined') {
                        // MERKEZ İSE: Sadece Tarih (Ön ek yok)
                        if (currentUser.yetki === 'merkez') {
                            baslikMetni = "";
                        }
                        // DİĞERLERİ (BÖLGE / İL / DERGAH)
                        else {
                            // 1. BÖLGE HER ZAMAN VAR
                            if (currentUser.bolge) baslikMetni += currentUser.bolge + ". Bölge ";

                            // 2. İL (İl veya Dergah yetkilisiyse)
                            if (currentUser.il) baslikMetni += currentUser.il + " ";

                            // 3. DERGAH (Sadece Dergah yetkilisiyse)
                            if (currentUser.yetki === 'dergah' && currentUser.dergah) {
                                baslikMetni += currentUser.dergah + " ";
                            }
                        }
                    }

                    // TARİHİ EKLE
                    if (ayInput && yilInput) {
                        const ayIsmi = ayAdlari[ayInput.value] || "";
                        baslikMetni += ayIsmi + " " + yilInput.value + " ";
                    }

                    baslikMetni += "Raporu";

                    // BAŞLIĞI YAZDIR (Ekranda Gizli, Yazıcıda Görünür)
                    div.innerHTML += `
            <div class="d-none d-print-block text-center mb-4">
                <h4 class="fw-bold border-bottom pb-2">${baslikMetni.toUpperCase()}</h4>
            </div>`;

                } catch (e) { console.log("Başlık oluşturulamadı", e); }
                // ---------------------------------------------------

                // Hata Kontrolü
                if (!res || res.tur === "hata") {
                    div.innerHTML += `<div class="alert alert-danger text-center">${res ? res.mesaj : "Veri alınamadı."}</div>`;
                    return;
                }

                if (res.tur === "mesaj") {
                    div.innerHTML += `<div class="alert alert-info text-center">${res.icerik}</div>`;
                    return;
                }

                // --- ÜST BİRİM RAPOR TABLOSU (İL/BÖLGE - YETKİLİ GÖRÜNÜM) ---
                if (res.tur === "ust_birim_veri") {
                    let html = `
        <div class="table-responsive bg-white rounded shadow-sm border">
            <table class="table table-bordered table-hover mb-0 text-center" style="font-size:0.85rem;">
                <thead class="table-secondary">
                    <tr class="align-middle">
                        <th class="bg-light">BİRİM</th>
                        <th class="text-primary">DÜKKAN DURUMU</th> <!- Eski: Genel Performans ->
                        <th class="text-primary">ZİYARET</th>
                        <th class="text-secondary">PERFORMANS</th> <!- Eski: Unutulan % bar ->
                        <th class="text-danger">UNUTULAN</th> <!- Eski usul sayı ->
                        <th class="text-dark bg-warning-subtle">STOK</th> <!- Eski: Stokta, Sahada kalktı ->
                        <th class="text-success">BU AY DAĞITILAN</th> <!- Eski: Dağıtılan ->
                    </tr>
                </thead>
                <tbody>`;

                    let tGenel = 0, tZiyaret = 0, tUnutulan = 0, tDepo = 0, tDagitilan = 0;

                    res.liste.forEach(item => {
                        const isDepo = item.birimAdi.includes("Depo");
                        const satirClass = isDepo ? "table-warning fw-bold" : "";

                        // --- YETKİ İKONU ---
                        let yetkiBtn = "";
                        if (!isDepo) {
                            const isAuth = item.stokYetki === true;
                            const iconClass = isAuth ? "fa-lock-open" : "fa-lock";
                            const colorClass = isAuth ? "text-success" : "text-danger";
                            const titleText = isAuth ? "Yetkiyi Kaldır" : "Yetki Ver";

                            // İl yetkilisi sadece görür, değiştiremez (Değiştirme yetkisi backendde de kontrol ediliyor ama UI'da da kapatalım)
                            if (res.yetki !== 'il') {
                                yetkiBtn = `<i class="fa ${iconClass} ${colorClass} ms-2" style="cursor:pointer;" title="${titleText}" onclick="toggleYetki('${item.birimAdi}')"></i>`;
                            }
                        }

                        if (item.stokYetki) {
                            yetkiBtn += `<span class="badge bg-success ms-1" title="Stok Yetkisi Var"><i class="fa fa-check"></i></span>`;
                        }

                        // Performans Yüzdesi
                        const yuzde = item.genelToplam > 0 ? Math.round((item.buAyZiyaret / item.genelToplam) * 100) : 0;
                        let renk = "bg-danger";
                        if (yuzde >= 80) renk = "bg-success";
                        else if (yuzde >= 50) renk = "bg-warning";

                        html += `
            <tr class="${satirClass}">
                <td class="fw-bold text-start ps-3">
                    ${item.birimAdi} ${yetkiBtn}
                </td>
             <td>${item.genelToplam}</td>
             <td>${item.buAyZiyaret}</td>
             <td style="width: 15%;">
                <div class="progress" style="height: 20px;">
                    <div class="progress-bar ${renk}" style="width: ${yuzde}%">${yuzde}%</div>
                </div>
             </td>
             <td class="text-danger fw-bold">${item.buAyUnutulan}</td> <!- Unutulan Sayısı ->
             <td class="bg-light border-start text-center"><b>${item.stokDepo}</b></td>
             <td class="text-center">${item.buAyDagitilan}</td>
           </tr>`;

                        tGenel += Number(item.genelToplam) || 0;
                        tZiyaret += Number(item.buAyZiyaret) || 0;
                        tUnutulan += Number(item.buAyUnutulan) || 0;
                        tDepo += Number(item.stokDepo) || 0;
                        tDagitilan += Number(item.buAyDagitilan) || 0;
                    });

                    html += `
            <tr class="table-dark fw-bold">
                <td class="text-start ps-3">GENEL TOPLAM</td>
                <td>${tGenel}</td><td>${tZiyaret}</td><td>-</td>
                <td>${tUnutulan}</td>
                <td class="text-warning">${tDepo}</td><td>${tDagitilan}</td>
            </tr>
        </tbody></table></div>
        <div class="mt-2 text-muted small fst-italic no-print">
            <i class="fa fa-info-circle"></i> "Dükkan Durumu" toplam aktif dükkan sayısını, "Stok" birim deposundaki sayıyı ifade eder. "Unutulan" ise bu ay hiç gidilmeyenlerdir.
        </div>`;

                    div.innerHTML += html;
                    return;
                }

                // --- STANDART RAPOR TABLOSU (DERGAH/DETAY) ---
                if (res.tur === "detay") {
                    const bolumler = Object.keys(res.veriler).sort();

                    if (bolumler.length === 0) {
                        div.innerHTML += '<div class="alert alert-warning">Kayıt yok.</div>';
                        return;
                    }

                    let html = "";
                    bolumler.forEach(bolum => {
                        const v = res.veriler[bolum];
                        html += `<div class="card mb-3 shadow-sm border-0"><div class="card-header bg-white border-bottom"><div class="d-flex justify-content-between align-items-center"><span class="fw-bold text-primary">${bolum}</span><span class="badge bg-light text-dark border">${v.ziyaretSayisi} / ${v.toplamDukkan}</span></div></div><div class="table-responsive"><table class="table table-hover mb-0" style="font-size:0.9rem;"><thead class="table-light"><tr><th>Dükkan</th><th class="text-center" style="width:120px;">Tarih</th></tr></thead><tbody>`;

                        v.kayitlar.forEach(k => {
                            const renk = k.durumClass.includes('success') ? 'text-success fw-bold' : 'text-danger';
                            const icon = k.durumClass.includes('success') ? '<i class="fa fa-check-circle ms-1"></i>' : '';
                            html += `<tr><td>${k.dukkan}</td><td class="text-center ${renk} text-nowrap">${k.tarih} ${icon}</td></tr>`;
                        });

                        html += `</tbody></table></div></div>`;
                    });
                    div.innerHTML += html;
                }
            }

            function ihmalGetir() {
                const gun = document.getElementById('ihmal-gun').value;
                const div = document.getElementById('rapor-sonuc');
                div.innerHTML = '<div class="text-center p-4"><div class="spinner-border text-danger"></div><div>Taranıyor...</div></div>';

                run('kutu_unutulanlar', { gun, username: currentUser.email }).then(res => {
                    const keys = Object.keys(res);
                    if (keys.length === 0) {
                        div.innerHTML = '<div class="alert alert-success mt-3 text-center"><i class="fa fa-check-circle fa-2x mb-2"></i><br>Tebrikler! Unutulan dükkan yok.</div>';
                        return;
                    }

                    let html = `<div class="alert alert-danger mt-2 text-center"><strong>${gun} Gündür Unutulanlar</strong></div>`;
                    keys.forEach(k => {
                        html += `<div class="card mb-3 border-danger"><div class="card-header bg-danger text-white">${k}</div><ul class="list-group list-group-flush">`;
                        res[k].forEach(item => {
                            html += `<li class="list-group-item d-flex justify-content-between">
                    <span>${item.dukkan}</span>
                    <span class="badge bg-danger rounded-pill">${item.gun} gün</span>
                </li>`;
                        });
                        html += "</ul></div>";
                    });
                    div.innerHTML = html;
                });
            }

            function raporYazdir() {
                window.print();
            }

            function anaSayfayaDon() { window.top.location.href = API_URL; }

            function ekranDuzenleHazirla() {
                run('kutu_duzenle_bolumler', { username: currentUser.email }).then(res => {
                    const sel = document.getElementById('edit-bolum-select');
                    const formSel = document.getElementById('form-bolum');
                    sel.innerHTML = '<option value="">Bölüm Seçiniz...</option>';
                    formSel.innerHTML = '';

                    // Gelen verileri ekle
                    res.forEach(b => {
                        sel.innerHTML += `<option value="${b}">${b}</option>`;
                        formSel.innerHTML += `<option value="${b}">${b}</option>`;
                    });

                    // KRİTİK DÜZELTME: Yeni eklenen ama henüz dükkanı olmayan bölümü listeye dahil et
                    if (sonEklenenBolum && !res.includes(sonEklenenBolum)) {
                        sel.innerHTML += `<option value="${sonEklenenBolum}">${sonEklenenBolum}</option>`;
                        formSel.innerHTML += `<option value="${sonEklenenBolum}">${sonEklenenBolum}</option>`;
                    }
                });
            }

            function editBolumSecildi() {
                const bolum = document.getElementById('edit-bolum-select').value;
                const sel = document.getElementById('edit-dukkan-select');
                sel.innerHTML = '<option>Yükleniyor...</option>';
                if (!bolum) { sel.innerHTML = '<option value="">Önce Bölüm Seçiniz</option>'; return; }
                run('kutu_duzenle_dukkanlar', { bolum, username: currentUser.email }).then(res => {
                    sel.innerHTML = '<option value="">Dükkan Seçiniz...</option>';
                    res.forEach(d => { sel.innerHTML += `<option value="${d.id}">${d.ad}</option>`; });
                });
            }

            function duzenleButonu() {
                const id = document.getElementById('edit-dukkan-select').value;
                if (!id) return ozelAlert("Lütfen dükkan seçiniz.");
                run('kutu_duzenle_detay', { id, username: currentUser.email }).then(res => {
                    document.getElementById('edit-form-container').classList.remove('d-none');
                    document.getElementById('sort-container').classList.add('d-none');
                    document.getElementById('form-id').value = res.id;
                    document.getElementById('form-bolum').value = res.bolum;
                    document.getElementById('form-dukkan').value = res.dukkan;
                    document.getElementById('form-sorumlu').value = res.sorumlu;
                    document.getElementById('form-sahibi').value = res.sahibi;
                    document.getElementById('form-telefon').value = res.telefon;
                    document.getElementById('form-adres').value = res.adres;
                    document.getElementById('form-detay').value = res.detay;
                });
            }

            function yeniButonu() {
                document.getElementById('edit-form-container').classList.remove('d-none');
                document.getElementById('sort-container').classList.add('d-none');
                document.getElementById('form-id').value = "";
                document.getElementById('form-dukkan').value = "";
                document.getElementById('form-sorumlu').value = "";
                document.getElementById('form-sahibi').value = "";
                document.getElementById('form-telefon').value = "";
                document.getElementById('form-adres').value = "";
                document.getElementById('form-detay').value = "";
                const aktifBolum = document.getElementById('edit-bolum-select').value;
                if (aktifBolum) document.getElementById('form-bolum').value = aktifBolum;
            }

            function kaydetForm() {
                const data = {
                    id: document.getElementById('form-id').value,
                    bolum: document.getElementById('form-bolum').value,
                    dukkan: document.getElementById('form-dukkan').value,
                    sorumlu: document.getElementById('form-sorumlu').value,
                    sahibi: document.getElementById('form-sahibi').value,
                    telefon: document.getElementById('form-telefon').value,
                    adres: document.getElementById('form-adres').value,
                    detay: document.getElementById('form-detay').value
                };
                if (!data.bolum || !data.dukkan) return ozelAlert("Bölüm ve Dükkan Adı zorunludur.");
                run('kutu_duzenle_kaydet', { form: data, username: currentUser.email }).then(res => {
                    ozelAlert(res.mesaj);
                    formKapat();
                    editBolumSecildi();
                });
            }

            function silForm() {
                const id = document.getElementById('form-id').value;
                if (!id) return;
                ozelAlert("Bu dükkan silinecek (pasife alınacak). Emin misiniz?", "Dikkat", function () {
                    run('kutu_duzenle_sil', { id, username: currentUser.email }).then(res => {
                        ozelAlert(res.mesaj);
                        formKapat();
                        editBolumSecildi();
                    });
                });
            }

            function formKapat() { document.getElementById('edit-form-container').classList.add('d-none'); }

            let sortableList = null;
            function siralaModuAc() {
                const bolum = document.getElementById('edit-bolum-select').value;
                if (!bolum) return ozelAlert("Önce Bölüm Seçiniz.");
                formKapat();
                const sortDiv = document.getElementById('sort-container');
                const ul = document.getElementById('sort-list');
                sortDiv.classList.remove('d-none');
                ul.innerHTML = '<div class="spinner-border text-primary"></div>';
                run('kutu_duzenle_dukkanlar', { bolum, username: currentUser.email }).then(res => {
                    ul.innerHTML = "";
                    res.forEach(d => {
                        const li = document.createElement('li');
                        li.className = "list-group-item sort-item";
                        li.setAttribute('data-id', d.id);
                        li.innerHTML = `<i class="fa fa-bars text-muted me-2"></i> ${d.ad}`;
                        li.style.cursor = "move";
                        ul.appendChild(li);
                    });
                    if (sortableList) sortableList.destroy();
                    sortableList = new Sortable(ul, { animation: 150, ghostClass: 'bg-light' });
                });
            }

            function siralaKaydet() {
                const items = document.querySelectorAll('#sort-list li');
                const order = Array.from(items).map(li => li.getAttribute('data-id'));
                run('kutu_duzenle_sirala', { order, username: currentUser.email }).then(res => {
                    ozelAlert(res.mesaj);
                    sortKapat();
                });
            }

            function sortKapat() { document.getElementById('sort-container').classList.add('d-none'); }

            // --- STOK MODAL İŞLEMLERİ ---

            // --- STOK MODAL İŞLEMLERİ (GÜNCELLENMİŞ) ---

            function openStokModal() {
                const modalEl = document.getElementById('modal-stok-islem');
                const modal = new bootstrap.Modal(modalEl);

                // 1. Yetki Kontrolleri
                const isDergah = (currentUser.yetki === 'dergah');

                // Manuel Giriş Sekmesi
                const tabGiris = document.getElementById('nav-item-giris');
                if (currentUser && currentUser.stokManuelYetki) {
                    tabGiris.classList.remove('d-none');
                } else {
                    tabGiris.classList.add('d-none');
                }

                // 2. Dergah Kısıtlaması (Transfer/İade Gizle, Uyarı Göster)
                if (isDergah) {
                    // Transfer
                    document.getElementById('form-transfer').classList.add('d-none');
                    document.getElementById('alert-transfer-dergah').classList.remove('d-none');
                    // İade
                    document.getElementById('form-iade').classList.add('d-none');
                    document.getElementById('alert-iade-dergah').classList.remove('d-none');
                } else {
                    // Yönetici (İl/Bölge)
                    document.getElementById('form-transfer').classList.remove('d-none');
                    document.getElementById('alert-transfer-dergah').classList.add('d-none');
                    document.getElementById('form-iade').classList.remove('d-none');
                    document.getElementById('alert-iade-dergah').classList.add('d-none');

                    // Listeleri Doldur (Sadece yetkili ise)
                    loadStokAltBirimler();
                }

                modal.show();
            }

            // Yardımcı: Alt Birimleri Getir (Sadece İl/Bölge için çalışır)
            function loadStokAltBirimler() {
                const selTransfer = document.getElementById('stok-transfer-hedef');
                const selIade = document.getElementById('stok-iade-hedef');

                selTransfer.innerHTML = '<option>Yükleniyor...</option>';
                selIade.innerHTML = '<option>Yükleniyor...</option>';

                run('kutu_stok_alt_birimler', { username: currentUser.email }).then(res => {
                    let html = '<option value="">Seçiniz...</option>';
                    if (res && Array.isArray(res)) {
                        res.forEach(b => {
                            html += `<option value="${b}">${b}</option>`;
                        });
                    }
                    selTransfer.innerHTML = html;
                    selIade.innerHTML = html;
                });
            }

            // YENİ: Stok Geçmişini Yükle
            function loadStokGecmisi() {
                const yil = document.getElementById('stok-gecmis-yil').value;
                const tbody = document.getElementById('stok-gecmis-tbody');

                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted p-3"><i class="fa fa-spinner fa-spin"></i> Veriler getiriliyor...</td></tr>';

                run('kutu_stok_gecmis', { username: currentUser.email, filtreYil: yil }).then(data => {
                    if (!data || data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted p-3">Kayıt bulunamadı.</td></tr>';
                        return;
                    }

                    let html = '';
                    data.forEach(row => {
                        // Renklendirme
                        let badge = 'bg-secondary';
                        if (row.tur.includes('GİRİŞ')) badge = 'bg-success';
                        if (row.tur.includes('TRANSFER') || row.tur.includes('ÇIKIŞ')) badge = 'bg-warning text-dark';
                        if (row.tur.includes('ZAYİ')) badge = 'bg-danger';
                        if (row.tur.includes('İADE')) badge = 'bg-dark';

                        html += `
            <tr>
                <td><small>${row.tarih}</small></td>
                <td><span class="badge ${badge}">${row.tur}</span></td>
                <td class="fw-bold">${row.adet}</td>
                <td><small>${row.kaynak} &rarr; ${row.hedef}</small></td>
                <td><small class="text-muted text-truncate" style="max-width: 150px;">${row.aciklama}</small></td>
            </tr>`;
                    });
                    tbody.innerHTML = html;
                });
            }

            // --- DÜZELTİLMİŞ FRONTEND FONKSİYONU ---
            function stokIslemiYap(tur) {
                // DİKKAT: 'islem' yerine 'stokTuru' kullanıyoruz ki ana router ile çakışmasın.
                let data = { stokTuru: tur, username: currentUser.email };

                // Form verilerini topla
                if (tur === 'TRANSFER') {
                    data.hedef = document.getElementById('stok-transfer-hedef').value;
                    data.miktar = document.getElementById('stok-transfer-miktar').value;
                    data.aciklama = document.getElementById('stok-transfer-aciklama').value;
                    if (!data.hedef) return ozelAlert("Lütfen hedef birim seçiniz.");
                }
                else if (tur === 'IADE') {
                    data.hedef = document.getElementById('stok-iade-hedef').value;
                    data.miktar = document.getElementById('stok-iade-miktar').value;
                    data.aciklama = document.getElementById('stok-iade-aciklama').value;
                    if (!data.hedef) return ozelAlert("Lütfen kaynak birim seçiniz.");
                }
                else if (tur === 'GIRIS') {
                    data.miktar = document.getElementById('stok-giris-miktar').value;
                    data.aciklama = document.getElementById('stok-giris-aciklama').value;
                }
                else if (tur === 'ZAYI') {
                    data.miktar = document.getElementById('stok-zayi-miktar').value;
                    data.aciklama = document.getElementById('stok-zayi-aciklama').value;
                }

                if (!data.miktar || data.miktar <= 0) return ozelAlert("Lütfen geçerli bir miktar giriniz.");
                if (!data.aciklama) data.aciklama = "-";

                // Onay İste
                ozelAlert(`${tur} işlemini onaylıyor musunuz?`, "Dikkat", () => {
                    // Ana komut: 'kutu_stok_islem'
                    run('kutu_stok_islem', data).then(res => {
                        if (res.basarili) {
                            ozelAlert(res.mesaj);
                            bootstrap.Modal.getInstance(document.getElementById('modal-stok-islem')).hide();
                            loadKutuRapor();
                            // Dashboard güncelleme
                            run('kutu_dashboard', { username: currentUser.email }).then(d => {
                                if (d) document.getElementById('dash-stok').innerText = d.stok || 0;
                            });
                        } else {
                            ozelAlert(res.mesaj, "Hata");
                        }
                    });
                });
            }
            /* --- YENİ: Yetki Değiştirme Tetikleyicisi --- */
            function toggleYetki(birimAdi) {
                // Kullanıcıya işlem başladığını hissettirmek için basit bir loading (Opsiyonel ama iyi olur)
                // Şimdilik doğrudan gönderiyoruz.

                run('kutu_stok_yetki_degistir', {
                    username: currentUser.email,
                    target: birimAdi
                }).then(res => {
                    if (res && res.tur === 'ok') {
                        // Başarılı olursa raporu yenile ki ikonun rengi değişsin
                        ozelToast("Yetki güncellendi: " + (res.yeniDurum ? "VERİLDİ" : "ALINDI"), "success");
                        loadKutuRapor(); // Tabloyu yenile
                    } else {
                        ozelAlert(res.mesaj || "İşlem başarısız.", "Hata");
                    }
                });
            }

            function bolumYonetimiAc() { new bootstrap.Modal(document.getElementById('bolumYonetimModal')).show(); }

            // --- YILLIK RAPOR EKLENTİSİ (HATA DÜZELTME) ---

            function loadYillikRapor() {
                const yil = document.getElementById('rapor-yil').value;
                const btn = document.querySelector("button[onclick='loadYillikRapor()']");

                if (btn) {
                    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
                    btn.disabled = true;
                }

                run('kutu_rapor_yillik', { yil: yil, username: currentUser.email }).then(res => {
                    if (btn) {
                        btn.innerHTML = '<i class="fa fa-table me-1"></i> YILLIK';
                        btn.disabled = false;
                    }

                    if (res && res.tur === 'yillik_matris') {
                        renderYillikMatris(res.veriler, yil);
                    } else {
                        document.getElementById('rapor-sonuc').innerHTML = '<div class="alert alert-warning">Veri bulunamadı veya hata oluştu.</div>';
                    }
                });
            }

            function renderYillikMatris(data, yil) {
                if (!data || data.length === 0) {
                    document.getElementById('rapor-sonuc').innerHTML = '<div class="alert alert-info">Gösterilecek veri yok.</div>';
                    return;
                }

                // DINAMIK BAŞLIK
                const baslikText = `${yil} YILLIK PERFORMANS RAPORU`;
                let html = `<div class="text-center mb-3">
                    <h5 class="fw-bold text-primary border-bottom pb-2">${baslikText}</h5>
                </div>`;

                html += `<div class="table-responsive bg-white rounded shadow-sm">
                    <table class="table table-bordered table-hover table-sm text-center align-middle" style="font-size:0.85rem;">
                        <thead class="table-dark text-white annual-header">
                            <tr>
                                <th class="text-start" style="width:150px;">BİRİM</th>`;

                // AY SÜTUNLARI (1-12)
                const aylar = ["", "Ocak", "Şubat", "Mart", "Nisan", "Mayıs", "Haziran", "Temmuz", "Ağustos", "Eylül", "Ekim", "Kasım", "Aralık"];
                for (let i = 1; i <= 12; i++) {
                    // Print modunda sadece sayı (1), Ekranda İsim (Ocak) gözüksün diye class ekliyoruz
                    html += `<th>
                        <span class="month-name">${aylar[i]}</span>
                        <span class="month-num" style="display:none;">${i}</span>
                    </th>`;
                }
                html += `</tr></thead><tbody>`;

                data.forEach(row => {
                    html += `<tr><td class="text-start fw-bold text-dark bg-light">${row.birim}</td>`;

                    for (let i = 1; i <= 12; i++) {
                        const cell = row[i];
                        // Hücre Formatı: Ziyaret / Toplam (Subscript ile)
                        // Eğer Toplam 0 ise boş geç
                        if (cell.toplam === 0) {
                            html += `<td class="text-muted bg-light">-</td>`;
                        } else {
                            // Renklendirme
                            const oran = cell.ziyaret / cell.toplam;
                            let bgClass = "";
                            if (oran === 1) bgClass = "bg-success text-white"; // %100
                            else if (oran >= 0.5) bgClass = "bg-success-subtle text-success-emphasis"; // %50+
                            else if (oran > 0) bgClass = "bg-warning-subtle"; // Ziyaret var ama az
                            else bgClass = "text-danger fw-bold"; // Hiç yok

                            html += `<td class="${bgClass}">${cell.ziyaret} <sub class="text-muted" style="font-size:0.65em;">/ ${cell.toplam}</sub></td>`;
                        }
                    }
                    html += `</tr>`;
                });

                html += `</tbody></table></div>
                <div class="mt-2 text-muted small fst-italic no-print">
                    <i class="fa fa-info-circle"></i> Hücreler: "Ziyaret Sayısı / O Dönemdeki Toplam Dükkan" formatındadır.
                </div>`;

                document.getElementById('rapor-sonuc').innerHTML = html;
            }

            // --- YENİ YÖNETİM FONKSİYONLARI ---

            // 1. PASİF DÜKKAN YÖNETİMİ
            function loadPasifDukkanlar() {
                const modal = new bootstrap.Modal(document.getElementById('modal-pasif'));
                modal.show();

                const div = document.getElementById('pasif-liste-container');
                div.innerHTML = '<div class="text-center p-3"><div class="spinner-border text-primary"></div></div>';

                run('kutu_duzenle_pasif_getir', { username: currentUser.email }).then(data => {
                    if (!data || data.length === 0) {
                        div.innerHTML = '<div class="alert alert-info m-3">Pasif dükkan bulunamadı.</div>';
                        return;
                    }

                    let html = '';
                    data.forEach(d => {
                        html += `
            <div class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                    <strong>${d.dukkan}</strong> <br>
                    <small class="text-muted">${d.bolum} | ${d.sorumlu}</small>
                </div>
                <button class="btn btn-sm btn-outline-success fw-bold" onclick="tekrarAktifEt('${d.id}')">
                    <i class="fa fa-recycle"></i> TEKRAR AKTİF ET
                </button>
            </div>`;
                    });
                    div.innerHTML = html;
                });
            }

            function tekrarAktifEt(id) {
                if (!confirm("Bu dükkan tekrar AKTİF edilecek ve stoktan 1 kutu düşülecek. Onaylıyor musunuz?")) return;

                // Yükleniyor...
                ozelAlert("İşlem yapılıyor, lütfen bekleyiniz...");

                run('kutu_duzenle_aktif_et', { id: id, username: currentUser.email }).then(res => {
                    if (res.basarili) {
                        ozelAlert(res.mesaj); // Başarı mesajı
                        // Modalı kapat ve listeyi yenile
                        var pasifModalEl = document.getElementById('modal-pasif');
                        var pasifModal = bootstrap.Modal.getInstance(pasifModalEl);
                        if (pasifModal) pasifModal.hide();

                        // Eğer dashboard açıksa sayıları güncellemek iyi olur ama zorunlu değil
                        run('kutu_dashboard', { username: currentUser.email }).then(res => {
                            if (res) {
                                document.getElementById('dash-saha').innerText = res.saha || 0;
                                document.getElementById('dash-stok').innerText = res.stok || 0;
                            }
                        });

                    } else {
                        ozelAlert("HATA: " + res.mesaj);
                    }
                });
            }

            // 2. BÖLÜM YÖNETİMİ UI (YENİLENMİŞ)

            // Modal Açılışında Listeyi Yükle
            function bolumYonetimiAc() {
                // 1. Önce olası açık modaları ve kilitlenmeleri temizle
                const backdrop = document.querySelector('.modal-backdrop');
                if (backdrop) backdrop.remove();
                document.body.classList.remove('modal-open');
                document.body.style.overflow = '';
                document.body.style.paddingRight = '';

                // 2. Yeni Modalı Başlat
                const modalEl = document.getElementById('bolumYonetimModal');
                const modal = new bootstrap.Modal(modalEl);
                modal.show();

                // 3. Listeyi Yükle
                loadBolumYonetimListesi();
            }

            function loadBolumYonetimListesi() {
                const select = document.getElementById('yonetim-bolum-select');
                select.innerHTML = '<option>Yükleniyor...</option>';

                // Formu gizle
                toggleBolumForm(false);
                document.getElementById('btn-bolum-duzenle').disabled = true;
                document.getElementById('btn-bolum-sil').disabled = true;

                run('kutu_duzenle_bolumler', { username: currentUser.email }).then(bolumler => {
                    select.innerHTML = '';
                    if (!bolumler || bolumler.length === 0) {
                        select.add(new Option("(Hiç bölüm yok)", ""));
                        return;
                    }
                    bolumler.forEach(b => {
                        select.add(new Option(b, b));
                    });
                    // KRİTİK: Yönetim listesinde de persistence
                    if (sonEklenenBolum && !bolumler.includes(sonEklenenBolum)) {
                        select.add(new Option(sonEklenenBolum, sonEklenenBolum));
                    }
                }).catch(err => {
                    select.innerHTML = '<option>Hata oluştu</option>';
                    console.error(err);
                });
            }

            function bolumSecildiUI() {
                const val = document.getElementById('yonetim-bolum-select').value;
                const disabled = !val; // Değer yoksa disable et
                document.getElementById('btn-bolum-duzenle').disabled = disabled;
                document.getElementById('btn-bolum-sil').disabled = disabled;
                toggleBolumForm(false); // Seçim değişince formu kapat
            }

            function toggleBolumEkle() {
                document.getElementById('bolum-islem-mode').value = 'new';
                document.getElementById('bolum-form-label').innerText = "Yeni Bölüm Adı";
                document.getElementById('bolum-input-ad').value = "";
                toggleBolumForm(true);
            }

            function toggleBolumDuzenle() {
                const val = document.getElementById('yonetim-bolum-select').value;
                if (!val) return;

                document.getElementById('bolum-islem-mode').value = 'edit';
                document.getElementById('bolum-eski-ad').value = val;
                document.getElementById('bolum-form-label').innerText = "Bölüm İsmini Düzenle";
                document.getElementById('bolum-input-ad').value = val;
                toggleBolumForm(true);
            }

            function toggleBolumForm(show) {
                const el = document.getElementById('bolum-islem-form');
                if (show) {
                    el.classList.remove('d-none');
                    document.getElementById('bolum-input-ad').focus();
                } else {
                    el.classList.add('d-none');
                }
            }

            function bolumKaydetUI() {
                const mode = document.getElementById('bolum-islem-mode').value;
                const ad = document.getElementById('bolum-input-ad').value.trim();

                if (!ad) {
                    ozelAlert("Lütfen bir isim yazınız.", "Uyarı");
                    return;
                }

                // LOADING: Butonsuz Modal
                ozelAlert("İşlem yapılıyor, lütfen bekleyiniz...", "Bilgi", "loading");

                if (mode === 'new') {
                    run('kutu_bolum_ekle', { yeniAd: ad, username: currentUser.email }).then(res => {
                        closeOzelAlert(); // Loading kapa

                        if (res.tur === 'ok') {
                            // HAFIZAYA AL
                            sonEklenenBolum = ad;

                            // KRİTİK EKLENTİ: Yeni bölümü MANUEL olarak arayüz listelerine ekle
                            // Çünkü veritabanında henüz dükkan olmadığı için listelenmeyebilir.

                            // 1. Yönetim Listesi
                            const sYonetim = document.getElementById('yonetim-bolum-select');
                            sYonetim.add(new Option(ad, ad));
                            sYonetim.value = ad; // Seçili yap

                            // 2. Dükkan Düzenleme - Bölüm Filtresi
                            const sEditFilter = document.getElementById('edit-bolum-select');
                            if (sEditFilter) sEditFilter.add(new Option(ad, ad));

                            // 3. Yeni Dükkan Formu - Bölüm Seçimi
                            const sForm = document.getElementById('form-bolum');
                            if (sForm) sForm.add(new Option(ad, ad));

                            // Kullanıcıya Yönlendirme Mesajı
                            ozelAlert(
                                "<b>Bölüm listeye eklendi.</b><br><br>" +
                                "⚠️ Henüz içinde dükkan olmadığı için, sayfa yenilenirse kaybolabilir.<br>" +
                                "👉 Lütfen hemen 'Dükkan İşlemleri' menüsünden bu bölüme bir dükkan ekleyiniz.",
                                "Başarılı"
                            );

                            // Formu Gizle
                            toggleBolumForm(false);

                        } else {
                            ozelAlert("Hata: " + res.mesaj, "Hata");
                        }
                    });
                } else if (mode === 'edit') {
                    const eskiAd = document.getElementById('bolum-eski-ad').value;
                    run('kutu_bolum_rename', { eskiAd: eskiAd, yeniAd: ad, username: currentUser.email }).then(res => {
                        closeOzelAlert();
                        ozelAlert(res.mesaj, "Bilgi");
                        loadBolumYonetimListesi();
                    });
                }
            }

            function bolumSilUI() {
                const ad = document.getElementById('yonetim-bolum-select').value;
                if (!ad) return;

                // Özel Alert ile Onay Al (Basit confirm yerine)
                ozelAlert(`'${ad}' bölümü silinecek. (Sadece içinde dükkan yoksa silinebilir). <br><br><b>Onaylıyor musunuz?</b>`, "Dikkat", function () {
                    // Onay verilirse çalışacak callback
                    ozelAlert("Siliniyor...", "Bilgi");
                    run('kutu_bolum_sil', { bolumAd: ad, username: currentUser.email }).then(res => {
                        ozelAlert(res.mesaj, "Sonuç");
                        loadBolumYonetimListesi();
                    });
                });
            }

            // 3. BÖLÜM SIRALAMA (Drag & Drop)
            function openBolumSiralama() {
                // 1. UI Değişikliği
                // Eski ID 'bolum-btn-group' idi, şimdi 'bolum-yonetim-main'
                const mainDiv = document.getElementById('bolum-yonetim-main');
                const sortDiv = document.getElementById('bolum-siralama-container');

                if (mainDiv) mainDiv.classList.add('d-none');
                if (sortDiv) sortDiv.classList.remove('d-none');

                const listEl = document.getElementById('bolum-sort-list');
                listEl.innerHTML = '<li class="list-group-item text-center"><div class="spinner-border spinner-border-sm"></div></li>';

                // 2. Bölümleri Getir (Var olan fonksiyonu kullanıyoruz: Edit listesi bölümleri de içerir)
                run('kutu_duzenle_bolumler', { username: currentUser.email }).then(bolumler => {
                    if (!bolumler || bolumler.length === 0) {
                        listEl.innerHTML = '<li class="list-group-item">Bölüm bulunamadı.</li>';
                        return;
                    }

                    let html = '';
                    bolumler.forEach(b => {
                        html += `<li class="list-group-item bg-light" data-id="${b}"><i class="fa fa-bars me-2 text-muted"></i> ${b}</li>`;
                    });
                    listEl.innerHTML = html;

                    // Sortable Başlat - Eğer Sortable kütüphanesi yüklenmediyse hata vermesin
                    if (typeof Sortable !== 'undefined') {
                        new Sortable(listEl, {
                            animation: 150,
                            ghostClass: 'bg-primary'
                        });
                    } else {
                        ozelAlert("Sıralama kütüphanesi yüklenemedi. Lütfen sayfayı yenileyiniz.");
                    }
                }).catch(err => {
                    listEl.innerHTML = '<li class="list-group-item text-danger">Hata: ' + err + '</li>';
                });
            }

            function closeBolumSiralama() {
                const mainDiv = document.getElementById('bolum-yonetim-main');
                const sortDiv = document.getElementById('bolum-siralama-container');

                if (sortDiv) sortDiv.classList.add('d-none');
                if (mainDiv) mainDiv.classList.remove('d-none');
            }

            function saveBolumSiralamaUI() {
                const listItems = document.querySelectorAll('#bolum-sort-list li');
                const sira = Array.from(listItems).map(li => li.getAttribute('data-id'));

                if (sira.length === 0) return;

                ozelAlert("Sıralama kaydediliyor...");

                run('kutu_bolum_siralama_kaydet', { siraListesi: sira, username: currentUser.email }).then(res => {
                    ozelAlert(res.mesaj);
                    closeBolumSiralama();
                });
            }

            function openModule(moduleName) {
                if (!currentUser) return;

                let targetUrl = API_URL + "?sayfa=" + moduleName;
                targetUrl += "&user=" + encodeURIComponent(currentUser.email);

                // Open in same tab (SPA feel)
                window.top.location.href = targetUrl;
            }
        </script>
</body>

</html>
